/*! rin-pr 2015-01-21 */
"use strict";function rin_template(a){return"templates/"+a+".html?v="+rin_version}function rejustifyImagesInTorrentDetails(){var a=$(".torrent-info .torrent-introduction");if(a&&a.length>0){var b=a.find("img");if(b&&b.length>0)for(var c=a.width(),d=0;d<b.length;d++){var e=$(b[d]).attr("style");if(e){var f=e.match(/width\s*?:\s*?([0-9]*?)px/i),g=e.match(/height\s*?:\s*?([0-9]*?)px/i);if(f&&g){var h=parseInt(f[1]),i=parseInt(g[1]);h&&i&&h>c&&(i=Math.round(i*c/h),h=c,$(b[d]).css("width",h+"px").css("height",i+"px"))}}}}}function buildTreeview(a){if(!(a instanceof Array))return{};for(var b=0,c={id:b++,text:"root"},d=0;d<a.length;d++){var e="",f="";a[d]instanceof Array?(e=a[d][0],f=a[d][1]):e=a[d];for(var g=e.split("/"),h=c,i=0;i<g.length-1;i++){h.item||(h.item=[]);for(var j=!1,k=0;k<h.item.length;k++)if(h.item[k].text==g[i]){h=h.item[k],j=!0;break}j||(h.item.push({id:b++,text:g[i]}),h=h.item[h.item.length-1])}h.item||(h.item=[]),h.item.push({id:b++,text:g[g.length-1]+(f?' <span class="filesize">'+f+"</span>":"")})}return c}var rin_version="0.1.22",disqus_shortname="bangumi",rin=angular.module("rin",["ngProgress","ui.router","pascalprecht.translate","ngMaterial","ngAnimate","ipCookie","angular-md5","angularMoment","angular-redactor","ngDisqus","ui.bootstrap.datetimepicker","angular-intro"]).run(["$rootScope","$state","$stateParams","$translate","$location","$urlRouter","$http","$filter","$q","amMoment","$mdDialog","ipCookie","ngProgress","redactorOptions",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){m.start(),a.$state=b,a.$stateParams=c;var o=function(){var a,c=e.path(),d=c.match(/^\/([a-z]*)\/?/);return a=d&&d[0]?d[1]?d[1]:"root":b.current?b.current.name:null},p=null;a.$on("$locationChangeSuccess",function(a){var b=o();b&&b===p?a.preventDefault():(p=b,f.sync())});for(var q=["user","team","tag"],r={},s=0;s<q.length;s++)r[q[s]]=new ObjectCache("_id");a.intro=function(){var b=o();switch(b){case"root":a.introStart();break;case"search":a.searchIntroStart()}};var t=!1,u={};a.checkIntroAutoStart=function(){if(t){var b=o();u[b]||(u[b]=!0,a.intro())}},a.beforeChangeEvent=function(a){var b=angular.element(a).prop("id");"main-menu-button"==b&&$("html, body").animate({scrollTop:0},600)};var v=function(){a.baseIntroOptions={nextLabel:"<b>"+h("translate")("Next")+"</b>",prevLabel:h("translate")("Previous"),skipLabel:h("translate")("Skip"),doneLabel:"<b>"+h("translate")("Got it")+"</b>",exitOnEsc:!0,exitOnOverlayClick:!t,showStepNumbers:!1,keyboardNavigation:!0,showButtons:!0,showBullets:!0,showProgress:!1,scrollToElement:!0,disableInteraction:!0},a.introOptions=angular.copy(a.baseIntroOptions),a.introOptions.steps=[{element:"#animated-header",intro:"Welcome to bangumi.moe, click 'Next' to get started."},{element:"#tab3",intro:"Recently on showing bangumis by weekdays. If you are looking for a latest bangumi, just select it from here. You will be able to create filter if you are not satisfied with the results."},{element:"#bangumi-timeline-embed",intro:"Not decided which to watch yet? Timeline may help."},{element:"#bangumi-list-current",intro:"Full list of on showing bangumis of this season is here.",position:"left"},{element:"#torrents-list-latest",intro:"Latest posts listed here, you could load more at bottom.",position:"top"},{element:"#torrent-list-buttons",intro:"You will be able to create detailed search filter and the corresponding RSS feed here."},{element:"#main-menu-button",intro:"Click here to register, login, add new post, manage your team and your posts, as well as request to join a specified team.",position:"left"},{element:"#guide-show-button",intro:"And finally, you can review this guide here.",position:"top"}]};a.switchLang=function(b,c){a.showAdditionLang=!1,a.lang=b,d.use(b).then(v),c||l("locale",b,{expires:365}),j.changeLocale(b),n.lang=b},a.showTorrentDetailsDialog=function(a,b,c){b._id,k.showModal({controller:"TorrentDetailsCtrl",templateUrl:rin_template("torrent-details"),targetEvent:a,locals:{torrent:b},onComplete:function(){var a=buildTreeview(b.content),c=new dhtmlXTreeObject("files_tree","100%","100%",0);c.setImagePath("/images/dhxtree_skyblue/"),c.loadJSONObject(a)}})["finally"](function(){c&&c()})},a.editTorrent=function(a,b,c){k.showModal({controller:"TorrentPublishCtrl",templateUrl:rin_template("torrent-publish"),targetEvent:a,locals:{torrent:b,user:c}})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.removeTorrent=function(a,b,c){a.preventDefault(),confirm("Delete this torrent?")&&g.post("/api/torrent/remove",{_id:b._id},{cache:!1,responseType:"json"}).success(function(a){c(a&&a.success?null:!0)}).error(function(){c(!0)}),a.stopPropagation()},a.fetchTorrentUserAndTeam=function(a,b){for(var c=[],d=[],e=0;e<a.length;e++)a[e].uploader_id&&c.indexOf(a[e].uploader_id)<0&&c.push(a[e].uploader_id),a[e].team_id&&d.indexOf(a[e].team_id)<0&&d.push(a[e].team_id);var f=[],h=[],j={user:{_ids:c},team:{_ids:d}},k=function(c){if(c)for(var d=0;d<c.length;d++){var e=c[d].data,f=h[d];r[f].push(e);for(var g=j[f].data,i=0;i<e.length;i++)g[e[i]._id]=e[i]}for(var d=0;d<a.length;d++)j.user.data&&(a[d].uploader=j.user.data[a[d].uploader_id]),j.team.data&&(a[d].team=j.team.data[a[d].team_id]);b&&b()};for(var l in j)if(j[l]._ids.length>0){var m=r[l].find(j[l]._ids);m&&m[1]&&m[1].length&&(h.push(l),f.push(g.post("/api/"+l+"/fetch",{_ids:m[1]},{responseType:"json"}))),j[l].data=m[0]}f.length>0?i.all(f).then(k):(k(),b&&b())},a.fetchTags=function(a,b,c){"function"==typeof b&&(c=b,b=!1);var d=r.tag.find(a,!0),e=function(a){if(b){var d=a,e={};d.forEach(function(a){e[a._id]=a}),a=e}c(null,a)};d&&d[1]&&d[1].length?g.post("/api/tag/fetch",{_ids:d[1]},{cache:!1,responseType:"json"}).success(function(a){a?(r.tag.push(a),a=d[0].concat(a)):a=d[0],e(a)}).error(function(a){c(a)}):e(d[0])};var w=!0,x=l("locale");if(!x){t=!0,w=!1;var y=["zh_tw","zh_cn","en"];if(navigator.language){var z=navigator.language.toLowerCase().replace(/^en(-.+)/,"en").replace("-","_");y.indexOf(z)>=0&&(x=z)}x||(x="zh_tw")}a.switchLang(x,w),f.listen(),k.showModal=function(a){var b=a.onComplete;a.onComplete=function(){$("body").addClass("modal-open"),$(".md-dialog-container").addClass("modal"),b&&b()};var c=k.show(a);return c["finally"](function(){$("body").removeClass("modal-open")})}}]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider","$translateProvider","$compileProvider","redactorOptions","$disqusProvider",function(a,b,c,d,e,f,g,h){if(e.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}),d.hashPrefix("!"),f.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|magnet):/),b.otherwise("/"),a.state("root",{url:"/",templateUrl:rin_template("index-unified"),controller:"UnifiedIndexCtrl"}).state("tag",{url:"/tag/:tag_id",templateUrl:rin_template("tag-search"),controller:"TagSearchCtrl"}).state("bangumi",{url:"/bangumi/list",templateUrl:rin_template("bangumi-list"),controller:"BangumiListCtrl"}).state("torrent",{url:"/torrent/:torrent_id",templateUrl:rin_template("index-blank"),controller:"TorrentShowCtrl"}).state("search",{url:"/search/:tag_id",templateUrl:rin_template("search-filter"),controller:"SearchFilterCtrl"}).state("user-reset-password",{url:"/user/reset-password/:reset_key",templateUrl:rin_template("index-blank"),controller:"UserResetCtrl"}).state("help",{url:"/help",templateUrl:rin_template("page-help"),controller:"PageHelpCtrl"}),b.deferIntercept(),c.defaults.transformRequest=function(a){if(void 0===a)return a;var b=!1;if(angular.forEach(a,function(a){a instanceof FileList&&(b=!0)}),!b)return JSON.stringify(a);var c=new FormData;return angular.forEach(a,function(a,b){a instanceof FileList?1==a.length?c.append(b,a[0]):angular.forEach(a,function(a,d){c.append(b+"_"+d,a)}):c.append(b,a)}),c},c.defaults.headers.post["Content-Type"]=void 0,g.buttonSource=!0,g.imageEnableUpload=!1,g.imageUpload="/api/file/upload/image?for=redactor",g.imageManagerJson="/api/file/all/image",g.plugins=["fontsize","fontcolor","imagemanager","fullscreen"],h.setShortname(disqus_shortname),window.location.origin)h.setUrlPrefix(window.location.origin);else{var i=window.location.href.match(/(https?:\/\/[^\/]+)\/?/i);i&&i[0]&&h.setUrlPrefix(i[1])}}]).filter("to_trusted",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]).filter("tagname",["$rootScope",function(a){return function(b){if(!b)return"";var c=a.lang;return b.locale&&b.locale[c]?b.locale[c]:b.name}}]).directive("backgroundImage",function(){var a=(new Date).getMonth();return function(b,c){c.css({"background-image":"url(/images/bg/m"+a+".jpg)","background-size":"cover","-webkit-background-size":"cover","-moz-background-size":"cover","-o-background-size":"cover","background-attachment":"fixed","background-position":"center top","background-repeat":"repeat-x"})}}).directive("torrentList",function(){return{restrict:"A",scope:{torrents:"=torrentList",torrentProps:"=torrentProps"},templateUrl:rin_template("torrent-list"),link:function(a){if(a.showTorrentDetailsDialog=a.$parent.showTorrentDetailsDialog,a.torrentProps){for(var b=["user","team","loadMore","showTorrentEdit","editTorrent","removeTorrent"],c=0;c<b.length;c++)a[b[c]]=a.$parent[b[c]];var d=["currentPage","totalPages"];a.$parent.$watchGroup(d,function(b){for(var c=0;c<d.length;c++)a[d[c]]=b[c]})}}}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b){b.bind("change",function(b){a.$apply(function(){a.fileread=b.target.files})})}}}]).directive("newScope",function(){return{scope:!0,priority:450}}).controller("SidebarCtrl",["$scope","$rootScope","$http","$mdDialog","md5","ngProgress",function(a,b,c,d,e,f){a.isExpanded=!1,a.setUser=function(c){c&&c.email&&(c.emailHash=e.createHash(c.email)),a.user=c,b.user=c},a.expand=function(b){a.user?a.isExpanded=!a.isExpanded:a.showSigninDialog(b)},a.signout=function(){f.start(),c["delete"]("/api/user/signout",{cache:!1,responseType:"json"}).success(function(b){b&&b.success&&(a.setUser(null),a.isExpanded=!1,f.complete())})},a.showSigninDialog=function(b){d.show({controller:"UserSigninCtrl",templateUrl:rin_template("user-signin"),targetEvent:b,locals:{user:null}}).then(function(b){a.setUser(b),a.expand()})},a.showTeamDialog=function(b){d.show({controller:"TeamActionsCtrl",templateUrl:rin_template("team-actions"),targetEvent:b,locals:{user:a.user}}).then(function(){})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.showTagDialog=function(b){d.show({controller:"TagActionsCtrl",templateUrl:rin_template("tag-actions"),targetEvent:b,locals:{user:a.user}}).then(function(){})["finally"](function(){})},a.showBangumiDialog=function(b){d.show({controller:"BangumiActionsCtrl",templateUrl:rin_template("bangumi-actions"),targetEvent:b,clickOutsideToClose:!1,locals:{user:a.user}}).then(function(){})["finally"](function(){})},a.showPublishDialog=function(c){d.showModal({controller:"TorrentPublishCtrl",templateUrl:rin_template("torrent-publish"),targetEvent:c,clickOutsideToClose:!1,locals:{user:a.user,torrent:null}}).then(function(c){c&&(c.uploader=a.user,b.$emit("torrentAdd",c))})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.showUserDialog=function(b,c){d.show({controller:"UserActionsCtrl",templateUrl:rin_template("user-actions"),targetEvent:b,locals:{user:a.user,action:c}}).then(function(){})["finally"](function(){})},b.showUserDialog=a.showUserDialog,c.get("/api/user/session",{cache:!1,responseType:"json"}).success(function(b){b&&b._id&&a.setUser(b)})}]).controller("PageHelpCtrl",["$scope","ngProgress",function(a,b){b.complete()}]).controller("BangumiListCtrl",["$scope","$rootScope","$http","ngProgress",function(a,b,c,d){function e(c,e){b.fetchTags(c,!0,function(b,c){if(c&&(e.forEach(function(a,b){a.tag_id&&(e[b].tag=c[a.tag_id])}),a.teams))for(var f in a.teams)a.teams[f]&&a.teams[f].forEach(function(a){a.tag=c[a.tag_id]});d.complete()})}d.start(),a.weekDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a.weekDayThemes=["red","pink","purple","blue","cyan","green","deep-orange"],a.bangumis=[],a.data={},c.get("/api/bangumi/current",{responseType:"json"}).success(function(b){if(b){for(var d=b,f=[],g=[],h=0;h<d.length;h++)g.push(d[h].tag_id),f[d[h].showOn]?f[d[h].showOn].push(d[h]):f[d[h].showOn]=[d[h]];a.bangumis=f,c.post("/api/team/working",{tag_ids:g},{cache:!1,responseType:"json"}).success(function(b){if(b){a.teams=b,a.searchStates={};var c=[];for(var f in b)b[f]&&b[f].forEach(function(a){c.indexOf(a.tag_id)<0&&c.push(a.tag_id)});g=g.concat(c)}e(g,d)}).error(function(){e(g,d)})}}).error(function(){d.complete()})}]).controller("TorrentShowCtrl",["$state","$stateParams","$scope","$rootScope","$location","$http","$mdDialog","ngProgress",function(a,b,c,d,e,f,g,h){var i=b.torrent_id;return i?void f.post("/api/torrent/fetch",{_id:i},{responseType:"json"}).success(function(b){if(b){var c=b;d.fetchTorrentUserAndTeam([c],function(){h.complete()}),d.showTorrentDetailsDialog(null,c,function(){a.current&&"torrent"==a.current.name&&e.path("/")})}else h.complete()}).error(function(){h.complete()}):void e.path("/")}]).controller("UserResetCtrl",["$stateParams","$scope","$window","$mdDialog","ngProgress",function(a,b,c,d,e){e.complete();var f=a.reset_key;return f?void d.show({controller:"UserSigninCtrl",templateUrl:rin_template("user-signin"),clickOutsideToClose:!1,locals:{user:{resetKey:f}}}).then(function(){c.location="/"}):void(c.location="/")}]).controller("UserSigninCtrl",["$scope","$http","$filter","$mdDialog","md5","ngProgress","user",function(a,b,c,d,e,f,g){var h=JobActionsWrapper(a,f);a.user=g?g:{},g&&(a.isForgot=!0),a.switchMode=function(b){h.reset()&&("forgot"==b?(a.isRegister=!1,a.isForgot=!0):a.isForgot?(a.isRegister=!1,a.isForgot=!1):a.isRegister=!a.isRegister)},a.signin=function(){if(h.reset()&&a.user.username&&a.user.password){h.start();var f={username:a.user.username,password:e.createHash(a.user.password)};b.post("/api/user/signin",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success)h.succeed(),d.hide(a.user);else{var b;a&&a.message&&(b=c("translate")(a.message)),h.fail(b)}}).error(function(){h.fail()})}},a.register=function(){if(h.reset()){if(a.user.password!=a.user.password2||a.user.password.length<6)return a.user.password=a.user.password2="",void h.fail();if(a.user.username&&a.user.password&&a.user.email){h.start();var f={username:a.user.username,email:a.user.email,password:e.createHash(a.user.password)};b.post("/api/user/register",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success){h.succeed(),d.hide(a.user);var b=c("translate")("Got it!"),e=c("translate")("Need to verify"),f=c("translate")("Done! We've sent you an email with instructions to verify your account.");d.show(d.alert().title(e).content(f).ok(b))}else{var g;a&&a.message&&(g=c("translate")(a.message)),h.fail(g)}}).error(function(){h.fail()})}}},a.reset=function(){if(h.reset())if(!a.user.resetKey&&a.user.username&&a.user.email){h.start();var f={username:a.user.username,email:a.user.email};b.post("/api/user/reset-password/request",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success){h.succeed(),d.cancel();var b=c("translate")("Got it!"),e=c("translate")("Reset Password"),f=c("translate")("Done! We've sent you an email with instructions to reset your password.");d.show(d.alert().title(e).content(f).ok(b))}else h.fail()}).error(function(){h.fail()})}else if(a.user.resetKey){if(a.user.password!=a.user.password2||a.user.password.length<6)return a.user.password=a.user.password2="",void h.fail();h.start();var f={username:a.user.username,password:e.createHash(a.user.password),resetKey:a.user.resetKey};b.post("/api/user/reset-password",f,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?(h.succeed(),d.hide()):h.fail()}).error(function(){h.fail()})}},a.close=function(){d.cancel()}}]).controller("UserActionsCtrl",["$scope","$rootScope","$http","$mdDialog","$q","md5","user","action","ngProgress",function(a,b,c,d,e,f,g,h,i){var j=JobActionsWrapper(a,i);a.subscriptions=[],a.focus_line=[],a.storrents=[],a.gravatarSubDomain="zh_cn"==b.lang?"cn":"zh_tw"==b.lang?"zh-tw":"en",a.showTorrentEdit=!0,a.removeTorrent=function(c,d,e){b.removeTorrent(c,d,function(b){b||(1==a.data.selectedIndex?a.mytorrents.splice(e,1):a.teamtorrents.splice(e,1))})},a.editTorrent=function(c,d,e){b.editTorrent(c,d,a.user,function(b,c){b||(1==a.data.selectedIndex?a.mytorrents[e]=c:a.teamtorrents[e]=c)})},a.user=g,a.data={};var k=!1;h&&"subscribe"==h.type&&h.selectedTagIds.length>0&&(k=!0,a.data.selectedIndex=1),i.start();var l=[];l.push(c.get("/api/user/subscribe/collections",{responseType:"json"})),l.push(c.get("/api/torrent/my",{responseType:"json"})),g.team_id&&(l.push(c.get("/api/torrent/team",{responseType:"json"})),l.push(c.post("/api/team/fetch",{_id:g.team_id},{responseType:"json"}))),e.all(l).then(function(d){var e=d[0].data;if(e&&e.length||k){var f=[];e||(e=[]);for(var j=0;j<e.length;j++)for(var l=0;l<e[j].length;l++)f.push(e[j][l]);if(k)for(var j=0;j<h.selectedTagIds.length;j++)f.push(h.selectedTagIds[j]);f.length>0&&b.fetchTags(f,!0,function(b,c){if(c){for(var d=[],f=0;f<e.length;f++){for(var g=[],i=0;i<e[f].length;i++)c[e[f][i]]&&g.push(c[e[f][i]]);g.length>0&&d.push(g)}if(k){for(var g=[],f=0;f<h.selectedTagIds.length;f++)c[h.selectedTagIds[f]]&&g.push(c[h.selectedTagIds[f]]);g.length>0&&d.push(g)}d.length>0&&(a.subscriptions=d,a.focus_line=new Array(d.length))}})}var m=d[1].data.torrents;if(m)for(var j=0;j<m.length;j++)m[j].uploader=g;if(a.mytorrents=m,g.team_id){var n=d[2].data.torrents,o=d[3].data;a.team=o,a.teamtorrents=n;var p=[];n&&n.forEach(function(a){p.push(a.uploader_id)}),p.length>0?c.post("/api/user/fetch",{_ids:p},{responseType:"json"}).success(function(a){for(var b=0;b<n.length;b++)for(var c=0;c<a.length;c++)if(n[b].uploader_id==a[c]._id){n[b].uploader=a[c];break}i.complete()}):i.complete()}else i.complete()}),a.showTorrentDetailsDialog=function(){},a.addLine=function(){a.subscriptions.push([]);for(var b=0;b<a.focus_line.length;b++)a.focus_line[b]=!1;a.ifocus=a.focus_line.length,a.focus_line.push(!0)},a.ifocus=0,a.removeLine=function(b){a.subscriptions.splice(b,1),a.ifocus==b&&(a.ifocus=-1),a.focus_line.splice(b,1)},a.editLine=function(b){a.ifocus=b,a.focus_line[b]=!0;for(var c=0;c<a.focus_line.length;c++)a.focus_line[c]=c==b},a.removeTag=function(b,c){var d=a.subscriptions[b],e=d.indexOf(c);e>=0&&d.splice(e,1),b==a.ifocus&&a.previewTorrents()},a.addKeywordsTag=function(b){if(!(a.ifocus<0)&&a.keywordsTags){var c=a.subscriptions[a.ifocus];c.indexOf(a.keywordsTags[b])>=0||(c.push(a.keywordsTags[b]),a.previewTorrents())}},a.previewTorrents=function(){if(a.storrents.splice(0,5),!(a.ifocus<0)){for(var d=a.subscriptions[a.ifocus],e=[],f=0;f<d.length;f++)e.push(d[f]._id);e.length<0||(j.start(),c.post("/api/torrent/search",{tag_id:e},{responseType:"json"}).success(function(c){c&&c.length?(c.length>5&&(c=c.slice(0,5)),b.fetchTorrentUserAndTeam(c,function(){j.succeed()}),Array.prototype.push.apply(a.storrents,c)):j.succeed()}).error(function(){j.succeed()}))}},a.save=function(){if(j.reset()){if(1==a.data.selectedIndex){for(var b=[],e=0;e<a.subscriptions.length;e++){for(var g=a.subscriptions[e],h=[],i=0;i<g.length;i++)h.push(g[i]._id);h.length>0&&b.push(h)}return j.start(),void c.post("/api/user/subscribe/update",{collections:b},{responseType:"json"}).success(function(a){a&&a.success?j.succeed():j.fail()}).error(function(){j.fail()})}if(a.user.password&&a.user.new_password&&!(a.user.new_password.length<6)){if(a.user.new_password!=a.user.new_password2)return a.user.new_password=a.user.new_password2="",void j.fail();var k={password:f.createHash(a.user.password),new_password:f.createHash(a.user.new_password)};c.post("/api/user/update",k,{responseType:"json"}).success(function(b){b&&b.success?(j.succeed(),a.user.password="",a.user.new_password=a.user.new_password2="",d.hide()):j.fail()}).error(function(){j.fail()})}}},a.close=function(){d.cancel()},a.canceler=null,a.$watch("data.tagname",function(b){a.canceler&&a.canceler.resolve();var d=b;d&&d.length>=2?(a.canceler=e.defer(),c.post("/api/tag/search",{name:d,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("TeamActionsCtrl",["$scope","$http","$q","$mdDialog","user","ngProgress",function(a,b,c,d,e,f){var g=JobActionsWrapper(a,f);a.user=e,a.data={},a.sync={},a.syncSites=["dmhy","ktxp","popgo","camoe"];for(var h=0;h<a.syncSites.length;h++)a.sync[a.syncSites[h]]={};a.newteam={},a.jointeam={},e.team_id?(b.get("/api/team/myteam",{responseType:"json"}).success(function(c){a.team=c,c.admin_id==e._id&&b.get("/api/team/members/pending",{responseType:"json"}).success(function(b){a.teamPendingMembers=b})}),b.get("/api/team/members",{responseType:"json"}).success(function(b){a.teamMembers=b}),b.get("/api/team/sync/get",{cache:!1,responseType:"json"}).success(function(b){if(b)for(var c=0;c<a.syncSites.length;c++){var d=a.syncSites[c];b[d]&&(a.sync[d]=b[d])}})):(b.get("/api/team/myjoining",{responseType:"json"}).success(function(b){a.teamJoining=b,a.jointeam.name=b.name}),b.get("/api/team/pending",{cache:!1,responseType:"json"}).success(function(b){a.teamPending=b})),"admin"==e.group&&b.get("/api/team/all/pending",{cache:!1,responseType:"json"}).success(function(c){var d=c;a.teamRequests=d;var e=[];c.forEach(function(a){e.push(a.admin_id)}),e.length>0&&b.post("/api/user/fetch",{_ids:e},{responseType:"json"}).success(function(a){for(var b=0;b<d.length;b++)for(var c=0;c<a.length;c++)if(d[b].admin_id==a[c]._id){d[b].admin=a[c];break}})}),a.join=function(){if(!a.canceler&&g.reset()){var c=a.jointeam;c&&c.name&&(g.start(),b.post("/api/team/join",c,{cache:!1,responseType:"json"}).success(function(c){c&&c.success&&b.get("/api/team/myjoining",{responseType:"json"}).success(function(b){b?(g.succeed(),a.keywordsTags=null,a.teamJoining=b,a.jointeam.name=b.name):g.fail()}).error(function(){g.fail()})}))}},a.remove=function(c,d,e){if(g.reset()){var f={team_id:d,user_id:e};b.post("/api/team/remove",f,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)for(var c=a.teamMembers,d=0;d<c.length;d++)if(c[d]._id==e){c.splice(d,1);break}})}},a.approve=function(c,d,e,f){if(g.reset()){var h={team_id:d,user_id:e};f&&(h.type="member"),b.post("/api/team/approve",h,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)for(var c=f?a.teamPendingMembers:a.teamRequests,g=0;g<c.length;g++){if(f&&c[g]._id==e){a.teamMembers.push(c[g]),c.splice(g,1);break}if(!f&&c[g]._id==d){c.splice(g,1);break}}})}},a.reject=function(c,d,e,f){if(g.reset()){var h={team_id:d,user_id:e};f&&(h.type="member"),b.post("/api/team/reject",h,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)for(var c=f?a.teamPendingMembers:a.teamRequests,g=0;g<c.length;g++)if(f&&c[g]._id==e||!f&&c[g]._id==d){c.splice(g,1);break}})}},a.approveMember=function(b,c,d){return a.approve(b,c,d,!0)},a.rejectMember=function(b,c,d){return a.reject(b,c,d,!0)},a.save=function(){if(g.reset()){if(3==a.data.selectedIndex)return void(a.sync&&(g.start(),b.post("/api/team/sync/update",{sync:a.sync},{cache:!1,responseType:"json"}).success(function(a){a&&a.success?g.succeed():g.fail()}).error(function(){g.fail()})));var c=a.team;if(c){g.start();var d={_id:c._id,icon:c.new_icon};d.signature=c.signature?c.signature:"",b.post("/api/team/update",d,{cache:!1,responseType:"json"}).success(function(c){c&&c.success?(g.succeed(),b.get("/api/team/myteam",{cache:!1,responseType:"json"}).success(function(b){a.team=b})):g.fail()}).error(function(){g.fail()})}}},a.submit=function(){if(g.reset()){var c=a.newteam;c&&c.name&&c.certification&&(g.start(),b.post("/api/team/register",c,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(g.succeed(),a.teamPending=b.team):g.fail()}).error(function(){g.fail()}))}},a.close=function(){d.cancel()},a.selectTag=function(b){a.jointeam.name=b.name},a.canceler=null,a.$watch("jointeam.name",function(d){if(a.canceler&&a.canceler.resolve(),a.teamJoining&&a.teamJoining._id)return a.canceler=null,void(a.keywordsTags=null);var e=d;e&&e.length>=2?(a.canceler=c.defer(),b.post("/api/tag/search",{name:e,type:"team",keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("TagActionsCtrl",["$scope","$http","$mdDialog","$q","user","ngProgress",function(a,b,c,d,e,f){function g(){if(a.tag.synonyms&&!(a.tag.synonyms.length<=0)){for(var b={},c=a.tag_locale,d=0;d<c.length;d++)if(c[d]&&a.tag.synonyms[d])if(c[d].indexOf(",")>=0)for(var e=c[d].split(","),f=0;f<e.length;f++)e[f]&&(b[e[f]]=a.tag.synonyms[d]);else b[c[d]]=a.tag.synonyms[d];return b}}function h(){if(!a.tag.synonyms||!a.tag.locale||a.tag.synonyms.length<=0)return void(a.tag_locale=[""]);var b=[];for(var c in a.tag.locale){var d=a.tag.synonyms.indexOf(a.tag.locale[c]);d>=0&&(b[d]?b[d]+=","+c:b[d]=c)}a.tag_locale=b}var i=JobActionsWrapper(a,f);a.tagTypeList=["team","bangumi","lang","resolution","format","misc"],a.user=e,a.tag={},a.tag_locale=[],a.search=function(){!a.canceler&&i.reset()&&a.tag.name&&(i.start(),b.post("/api/tag/search",{name:a.tag.name},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),b.found?(a.tag=b.tag,h()):(a.tag.synonyms=[""],a.tag_locale=[""],a.notfound=!0),a.keywordsTags=null):i.fail()}).error(function(){i.fail()}))},a.increase=function(){a.tag.synonyms.push(""),a.tag_locale.push("")},a.remove=function(b){a.tag.synonyms.splice(b,1),a.tag_locale.splice(b,1)},a.add=function(){if(i.reset()&&a.notfound){i.start();var c={name:a.tag.name,type:a.tag.type,synonyms:a.tag.synonyms,locale:g()};b.post("/api/tag/add",c,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.notfound=!1,a.tag=b.tag):i.fail()}).error(function(){i.fail()})}},a.save=function(){if(i.reset()&&a.tag._id){i.start();var c={_id:a.tag._id,name:a.tag.name,type:a.tag.type,synonyms:a.tag.synonyms,locale:g()};b.post("/api/tag/update",c,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?i.succeed():i.fail()}).error(function(){i.fail()})}},a["delete"]=function(){i.reset()&&a.tag._id&&(i.start(),b.post("/api/tag/remove",{_id:a.tag._id},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.notfound=!1,a.tag={},a.tag_locale=[]):i.fail()}).error(function(){i.fail()}))},a.selectTag=function(b){a.tag=b,h(),a.keywordsTags=null},a.close=function(){c.cancel()},a.canceler=null,a.$watch("tag.name",function(c){if(a.canceler&&a.canceler.resolve(),a.tag._id)return a.canceler=null,void(a.keywordsTags=null);var e=c;e&&e.length>=2?(a.canceler=d.defer(),b.post("/api/tag/search",{name:e,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("BangumiActionsCtrl",["$scope","$http","$filter","$mdDialog","user","ngProgress",function(a,b,c,d,e,f){function g(b){var c=new Date(b),d=c.getTime()+6e4*c.getTimezoneOffset(),e=parseInt(a.newbangumi.timezone);return new Date(d+36e5*e)}function h(a){return a&&a.name&&a.credit&&a.startDate&&a.endDate&&a.showOn>=0?!0:!1}var i=JobActionsWrapper(a,f);a.user=e,a.data={},a.bangumi={},a.newbangumi={timezone:9,showOn:0},a.date=null,a.weekDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a.setDate=function(b){a.settingDate=b},a.add=function(){if(i.reset()&&h(a.newbangumi)&&a.newbangumi.icon&&a.newbangumi.cover){i.start();var c={name:a.newbangumi.name,credit:a.newbangumi.credit,startDate:a.newbangumi.startDate.getTime(),endDate:a.newbangumi.endDate.getTime(),showOn:a.newbangumi.showOn,icon:a.newbangumi.icon,cover:a.newbangumi.cover};b.post("/api/bangumi/add",c,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.data.selectedIndex=1,a.bangumi=b.bangumi):i.fail()}).error(function(){i.fail()})}},a.save=function(){if(i.reset()){var c={_id:a.bangumi._id,name:a.bangumi.name,credit:a.bangumi.credit,startDate:a.newbangumi.startDate.getTime(),endDate:a.newbangumi.endDate.getTime(),showOn:a.newbangumi.showOn,icon:a.bangumi.icon,cover:a.bangumi.cover};c._id&&h(c)&&(i.start(),b.post("/api/bangumi/update",c,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?i.succeed():i.fail()}).error(function(){i.fail()}))}},a.search=function(){i.reset()&&a.bangumi.name&&(i.start(),b.post("/api/bangumi/search",{name:a.bangumi.name},{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success&&b.found){i.succeed(),a.bangumi=b.bangumi;var d=new Date(b.bangumi.startDate),e=new Date(b.bangumi.endDate);a.newbangumi.startDate=d,a.newbangumi.endDate=e,a.newbangumi.startDateFormat=c("amDateFormat")(d,"YYYY/MM/DD HH:mm:ss"),a.newbangumi.endDateFormat=c("amDateFormat")(e,"YYYY/MM/DD HH:mm:ss"),a.newbangumi.showOn=b.bangumi.showOn}else i.fail()}).error(function(){i.fail()}))},a["delete"]=function(){i.reset()&&a.bangumi._id&&(a.working=!0,b.post("/api/bangumi/remove",{_id:a.bangumi._id},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.bangumi={}):i.fail()}).error(function(){i.fail()}))},a.close=function(){d.cancel()},a.$watch("newbangumi.date",function(b){a.settingDate&&(a.newbangumi[a.settingDate+"Format"]=c("amDateFormat")(b,"YYYY/MM/DD HH:mm:ss"),a.newbangumi[a.settingDate]=g(b),a.settingDate="")}),a.$watch("newbangumi.timezone",function(){a.newbangumi.startDate=a.newbangumi.endDate=null,a.newbangumi.startDateFormat=a.newbangumi.endDateFormat=""})}]).controller("TorrentPublishCtrl",["$scope","$rootScope","$state","$filter","$http","$timeout","$mdDialog","$mdToast","$q","user","torrent","ngProgress",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=JobActionsWrapper(a,l);a.user=j,a.tags=[],a.categoryTags=[],e.get("/api/tag/misc",{responseType:"json"}).success(function(b){if(b&&b.length){a.categoryTags=b,a.categoryTag=b[0];for(var c=0;c<b.length;c++)if(k){if(b[c]._id==k.category_tag_id){a.categoryTag=b[c];break}}else if("donga"==b[c].name.toLowerCase()){a.categoryTag=b[c];break}}}),k?(a.torrent=k,k.team_id&&(a.torrent.inteam=!0),k.tag_ids&&k.tag_ids.length>0&&b.fetchTags(k.tag_ids,function(b,c){c&&(a.tags=c)})):(a.torrent={},j.team_id&&(a.torrent.inteam=!0)),a.publish=function(){if(m.reset()&&a.categoryTag&&a.torrent.title&&a.torrent.introduction&&a.torrent.title.length<128){if(!a.torrent._id&&!a.torrent_file)return;m.start();for(var b={category_tag_id:a.categoryTag._id,title:a.torrent.title,introduction:a.torrent.introduction,tag_ids:[],inteam:a.torrent.inteam?"1":""},c=0;c<a.tags.length;c++)b.tag_ids.push(a.tags[c]._id);var f;a.torrent._id?(f="/api/torrent/update",b._id=a.torrent._id):(f="/api/torrent/add",a.torrent.teamsync&&(b.teamsync="1"),b.file=a.torrent_file),e.post(f,b,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success)m.succeed(),g.hide(a.torrent);else{var b;a&&a.message&&(b=d("translate")(a.message)),m.fail(b)}}).error(function(){m.fail()})}},a.removeTag=function(b){a.tags.splice(b,1)},a.addTag=function(){a.newtag&&(a.working=!0,e.post("/api/tag/search",{name:a.newtag},{cache:!1,responseType:"json"}).success(function(b){if(a.working=!1,b&&b.found&&b.tag){for(var c=!1,d=0;d<a.tags.length;d++)if(a.tags[d]._id==b.tag._id){c=!0;break}c||a.tags.push(b.tag),a.newtag=""}}).error(function(){a.working=!1}))},a.contentSuggest=function(){a.torrent.title&&(a.working=!0,e.post("/api/torrent/suggest",{title:a.torrent.title,inteam:a.torrent.inteam},{cache:!1,responseType:"json"}).success(function(c){if(a.working=!1,c&&c._id){c.teamsync&&(a.torrent.teamsync=!0),c.team_id&&(a.torrent.inteam=!0),a.torrent.introduction=c.introduction;
var d=c.tag_ids;if(d&&d.length>0){for(var e=[],f=0;f<d.length;f++){for(var g=!1,h=0;h<a.tags.length;h++)if(a.tags[h]._id==d[f]){g=!0;break}g||e.push(d[f])}e.length>0&&b.fetchTags(e,function(b,c){if(c&&c.length>0){for(var d=[],e=0;e<c.length;e++)if("misc"!=c[e].type)if("resolution"==c[e].type||"lang"==c[e].type){for(var f=!1,g=0;g<a.tags.length;g++)if(a.tags[g].type==c[e].type){f=!0;break}f||d.push(c[e])}else d.push(c[e]);d.length>0&&(a.tags=a.tags.concat(d))}})}}}).error(function(){a.working=!1}))},a.getSuggest=function(){a.torrent.title&&(a.working=!0,e.post("/api/tag/suggest",{query:a.torrent.title},{cache:!1,responseType:"json"}).success(function(b){if(a.working=!1,b&&b.length>0)for(var c=0;c<b.length;c++){var d,e=null,f=!1;for(e="misc"==b[c].type?a.categoryTags:a.tags,d=0;d<e.length;d++)if(e[d]._id==b[c]._id){f=!0;break}"misc"==b[c].type?f&&(a.categoryTag=e[d]):f||a.tags.push(b[c])}}).error(function(){a.working=!1}))},a.close=function(){g.cancel()};var n=null;a.$watch("torrent.title",function(){n&&f.cancel(n),n=f(a.getSuggest,2e3)}),a.addKeywordsTag=function(b){if(a.keywordsTags&&a.keywordsTags[b]){for(var c=a.keywordsTags[b],d=!1,e=0;e<a.tags.length;e++)if(a.tags[e]._id==c._id){d=!0;break}d||a.tags.push(c)}},a.canceler=null,a.$watch("newtag",function(b){a.canceler&&a.canceler.resolve();var c=b;c&&c.length>=2?(a.canceler=i.defer(),e.post("/api/tag/search",{name:c,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("TorrentDetailsCtrl",["$scope","$rootScope","$http","$timeout","$mdDialog","$window","torrent","ngProgress",function(a,b,c,d,e,f,g,h){a.lang=b.lang,a.torrent=g,a.user=b.user,a.showComments=!1,a.showSyncStatus=!1,d(rejustifyImagesInTorrentDetails,500),g.content&&g.content.length<=1&&(a.fileContainer=!0),g.tag_ids&&g.tag_ids.length>0&&b.fetchTags(g.tag_ids,function(b,c){c&&(a.torrent.tags=c)}),a.downloadTorrent=function(a){a.downloads+=1;var b="/download/torrent/"+a._id+"/"+a.title.replace(/[\:\<\>\/\\\|\*\?\"]/g,"_")+".torrent",d=f.URL||f.webkitURL||f.mozURL||f.msURL,e=document.createElement("a");d&&"download"in e?(h.start(),c.get(b,{responseType:"arraybuffer"}).success(function(b){h.complete();var c=new Blob([b],{type:"application/octet-stream"}),g=d.createObjectURL(c);e.setAttribute("href",g),e.setAttribute("download",a.title+".torrent");var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!0,f,1,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(i)}).error(function(){h.complete()})):window.location=b},a.edit=function(c){b.editTorrent(c,a.torrent,a.user,function(){})},a.close=function(){e.cancel()}}]).controller("UnifiedIndexCtrl",["$scope","$rootScope","$state","$http","$q","$mdDialog","ngProgress",function(a,b,c,d,e,f,g){g.start(),a.currentPage=0,b.$on("torrentAdd",function(b,c){a.lattorrents.unshift(c)}),a.removeTorrent=function(c,d,e){b.removeTorrent(c,d,function(b){b||a.lattorrents.splice(e,1)})},a.editTorrent=function(c,d,e){b.editTorrent(c,d,a.user,function(b,c){b||(a.lattorrents[e]=c)})},a.lattorrents=[],a.coltorrents=[];var h=d.get("/api/torrent/latest",{cache:!1}),i=d.get("/api/bangumi/recent",{cache:!1}),j=d.get("/api/bangumi/timeline",{cache:!1}),k=d.get("/api/torrent/collections",{cache:!1}),l=[h,i,j,k];e.all(l).then(function(c){function d(){var c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=[],e=[],g={},i={},j=0;f.forEach(function(a){g[a.showOn]?g[a.showOn].push(a):g[a.showOn]=[a],i[a.showOn]=!0});for(var k=0,l=0;l<c.length;l++){for(var m=0,n=l;l+4>n;n++){var o=n%c.length;i[o]&&m++}m>k&&(k=m,j=l)}for(var n=j;j+4>n;n++){var o=n%c.length;e.push(c[o]),d.push(g[o])}d.length>1&&d[0]&&d[1]&&d[0].length>0&&d[1].length>0&&(h=d[0].length,d[2]&&d[2].length>0&&(h+=d[1].length,d[3]&&d[3].length>0&&(h+=1))),a.availableDays=e,a.showList=d,b.checkIntroAutoStart()}a.totalPages=c[0].data.page,Array.prototype.push.apply(a.lattorrents,c[0].data.torrents),Array.prototype.push.apply(a.coltorrents,c[3].data),a.currentPage=1,a.availableDays=[],a.data={},a.data.selectedIndex=2;var e=[],f=c[1].data,h=0;f.forEach(function(a){e.push(a.tag_id)}),d();var i=[].concat(a.lattorrents).concat(a.coltorrents);b.fetchTorrentUserAndTeam(i,function(){g.complete()}),b.fetchTags(e,!0,function(a,b){b&&(f.forEach(function(a,c){f[c].tag_id&&(f[c].tag=b[f[c].tag_id])}),d())}),window.embed_path="/scripts/timelinejs/";var j=b.lang;j=j.replace("_","-"),createStoryJS({type:"timeline",width:"100%",height:"500",lang:j,start_at_slide:h,source:c[2].data,embed_id:"bangumi-timeline-embed"})});var m=function(){g.start(),d.get("/api/torrent/page/"+(a.currentPage+1),{cache:!1,responseType:"json"}).success(function(c){if(c&&c.torrents){var d=c.torrents;b.fetchTorrentUserAndTeam(d,function(){g.complete()}),Array.prototype.push.apply(a.lattorrents,d),a.currentPage+=1}else g.complete()}).error(function(){g.complete()})};a.loadMore=m}]).controller("TagSearchCtrl",["$stateParams","$scope","$rootScope","$http","$q","ngProgress",function(a,b,c,d,e,f){f.start(),b.removeTorrent=function(a,d,e){c.removeTorrent(a,d,function(a){a||b.torrents.splice(e,1)})},b.editTorrent=function(){};var g=a.tag_id,h=d.post("/api/tag/fetch",{_id:g},{responseType:"json"}),i=d.post("/api/torrent/search",{tag_id:g},{responseType:"json"});e.all([h,i]).then(function(a){b.tag=a[0].data,b.torrents=a[1].data,c.fetchTorrentUserAndTeam(b.torrents,function(){f.complete()})})}]).controller("SearchFilterCtrl",["$scope","$rootScope","$state","$stateParams","$location","$http","$q","$timeout","$mdDialog","ngProgress",function(a,b,c,d,e,f,g,h,i,j){a.selectedTags=[];var k=[];a.searchByTitle=!1,a.tags={},a.tagTypeList=["lang","resolution","format","misc","bangumi","team"],a.torrents=[],a.searched=!1,a.tagsCollapse=!0,a.rsslink="/rss/latest",j.start(),a.searchIntroOptions=angular.copy(b.baseIntroOptions),a.searchIntroOptions.steps=[{element:"#search-filter-header",intro:"Welcome to search & filter page, click 'Next' to get started."},{element:"#filter-actions",intro:"Here, you can get a rss link and add to your own subscription if you have signin."},{element:"#filter-tag-list",intro:"Then, you can add or remove tags to filter by clicking the tags, and get the results instantly."},{element:"#filter-tag-search",intro:"Some tags are't list here, you can search them here."},{element:"#filter-mode-switch",intro:"After all, you can also do custom searching by title if you are't satisfied with the tags filter.",position:"left"}],h(function(){b.searchIntroStart=a.searchIntroStart,b.checkIntroAutoStart()},500),a.addSubscribe=function(a){k.length<=0||b.showUserDialog(a,{type:"subscribe",selectedTagIds:k})},a.update=function(){if(k.length<=0)return void e.path("/search/index");if("string"==typeof k)e.path("/search/"+k);else{for(var b="/search/",c=0;c<k.length;c++)b+=k[c],c<k.length-1&&(b+="+");e.path(b)}o(k,function(b,c){a.searched=!0,a.torrents=!b&&c?c:[]})};var l=[];if(l.push(f.get("/api/tag/popbangumi",{responseType:"json"})),l.push(f.get("/api/tag/team",{responseType:"json"})),l.push(f.get("/api/tag/common",{responseType:"json"})),d.tag_id&&"index"!==d.tag_id)if(-1!==d.tag_id.indexOf("+")){var m=d.tag_id.split("+");l.push(f.post("/api/tag/fetch",{_ids:m},{responseType:"json"}))}else l.push(f.post("/api/tag/fetch",{_id:d.tag_id},{responseType:"json"}));g.all(l).then(function(b){for(var c={},d=0;3>d;d++)if(b[d].data)for(var e=0;e<b[d].data.length;e++){var f=b[d].data[e];c[f.type]?c[f.type].push(f):c[f.type]=[f]}if(a.tags=c,b.length>3){if(b[3].data instanceof Array)b[3].data.forEach(function(b){b&&b._id&&a.addTag(b,!0)});else{var g=b[3].data;g&&g._id&&a.addTag(g,!0)}a.update()}else j.complete()}),a.searchTag=function(b){!b||b.length<2||(j.start(),a.searching="Searching...",f.post("/api/tag/search",{name:b,multi:!0},{responseType:"json"}).success(function(b){if(j.complete(),b.success&&b.found){a.searching="Search results for: ";for(var c=0;c<b.tag.length;c++)a.addTag(b.tag[c],!0);a.update()}else a.searching="No results found for: "}).error(function(){j.complete(),a.searching="Server error when searching for: "}))},a.canceler=null,a.$watch("newTagName",function(b){a.canceler&&a.canceler.resolve();var c=b;c&&c.length>=2?(a.canceler=g.defer(),f.post("/api/tag/search",{name:c,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null}),a.searchTitle=function(b){!b||b.length<2||o(b,function(b,c){a.searched=!0,a.torrents=!b&&c?c:[]})};var n=function(a,b){if(!a)return-1;for(var c=0;c<a.length;c++)if(a[c]._id==b._id)return c;return-1};a.addTag=function(b,c){var d=n(a.tags[b.type],b);d>=0&&a.tags[b.type].splice(d,1),n(a.selectedTags,b)>=0||(a.selectedTags.push(b),k.push(b._id),c||a.update())},a.removeTag=function(b){var c=n(a.selectedTags,b);c>=0&&(a.selectedTags.splice(c,1),k.splice(k.indexOf(b._id),1)),a.tags[b.type]?a.tags[b.type].push(b):a.tags[b.type]=[b],0===a.selectedTags.length&&(a.searched=!1,a.rsslink="/rss/latest"),a.update()};var o=function(c,d){j.start();var e={},g="/rss/tags/",h="/api/torrent/search";"string"==typeof c?(e.title=c,g="",h+="/title"):(e.tag_id=c,c.forEach(function(a,b){g+=a+(b+1<c.length?"+":"")})),a.rsslink=g,f.post(h,e,{responseType:"json"}).success(function(a){a&&a.length?b.fetchTorrentUserAndTeam(a,function(){j.complete(),d(null,a)}):(j.complete(),d())}).error(function(){j.complete(),d()})}}]);$(document).ready(function(){$("html").removeClass("no-js");var a=-1;$(window).scroll(function(){var b=$(this).scrollTop();b>100?$(".scrollup").fadeIn():$(".scrollup").fadeOut();var c=$(".bangumi-show");if(c&&c.length){for(var d=c.find("> section > md-toolbar"),e=-1,f=0;f<d.length&&b>=$(d[f]).offset().top;f++)e=f;if(0==e){var g=c.find("> md-toolbar");g&&g.length&&b<=g.offset().top+64&&(e=-1)}else e>0&&b<=$(d[e]).parent().offset().top-64&&e--;if(a>=0&&a!=e&&($(d[a]).attr("style","").removeClass("bangumi-top-title"),a=-1),e>=0&&a!=e){var h=$(d[0==e?e+1:e-1]).width();a=e,$(d[e]).css("width",h+"px").addClass("bangumi-top-title")}}}),$(".scrollup .fab").click(function(){return $("html, body").animate({scrollTop:0},600),!1})}),(-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.userAgent.indexOf("Trident"))&&$("html").addClass("msie");