/*! rin-pr 2015-05-09 */
"use strict";function rin_template(a){return"/templates/"+a+".html?v="+rin_version}function rejustifyImagesInTorrentDetails(){var a=$(".torrent-info .torrent-introduction");if(a&&a.length>0){var b=a.find("img");if(b&&b.length>0)for(var c=a.width(),d=0;d<b.length;d++){var e=$(b[d]).attr("style");if(e){var f=e.match(/width\s*?:\s*?([0-9]*?)px/i),g=e.match(/height\s*?:\s*?([0-9]*?)px/i);if(f&&g){var h=parseInt(f[1]),i=parseInt(g[1]);h&&i&&h>c&&(i=Math.round(i*c/h),h=c,$(b[d]).css("width",h+"px").css("height",i+"px"))}}}}}function buildTreeview(a){if(!(a instanceof Array))return{};for(var b=0,c={id:b++,text:"root"},d=0;d<a.length;d++){var e="",f="";a[d]instanceof Array?(e=a[d][0],f=a[d][1]):e=a[d];for(var g=e.split("/"),h=c,i=0;i<g.length-1;i++){h.item||(h.item=[]);for(var j=!1,k=0;k<h.item.length;k++)if(h.item[k].text==g[i]){h=h.item[k],j=!0;break}j||(h.item.push({id:b++,text:g[i]}),h=h.item[h.item.length-1])}h.item||(h.item=[]),h.item.push({id:b++,text:g[g.length-1]+(f?' <span class="filesize">'+f+"</span>":"")})}return c}var rin_version="0.1.52",disqus_shortname="bangumi",rin=angular.module("rin",["ngProgress","ui.router","pascalprecht.translate","ngMaterial","ngAnimate","ipCookie","angular-md5","angularMoment","angular-redactor","ngDisqus","ui.bootstrap.datetimepicker","angular-intro"]).run(["$rootScope","$state","$stateParams","$translate","$location","$window","$urlRouter","$http","$filter","$q","amMoment","$mdDialog","ipCookie","ngProgress","redactorOptions",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){n.start(),a.$state=b,a.$stateParams=c;var p={};a.setTitle=function(b,c,d){return d||!p.model&&!p.title?(a.pageModel=b,void(a.pageTitle=c)):(p.model=b,void(p.title=c))},a.pushTitle=function(b,c){p.model=a.pageModel,p.title=a.pageTitle,a.setTitle(b,c,!0)},a.popTitle=function(){a.setTitle(p.model,p.title,!0),p.model=p.title=null};var q=function(){var a,c=e.path(),d=c.match(/^\/([a-z]*)\/?/);return a=d&&d[0]?d[1]?d[1]:"root":b.current?b.current.name:null},r=null;a.$on("$locationChangeSuccess",function(a){var b=q();b&&b===r?a.preventDefault():(r=b,g.sync())});for(var s=["user","team","tag"],t={},u=0;u<s.length;u++)t[s[u]]=new ObjectCache("_id");a.intro=function(){var b=q();switch(b){case"root":a.introStart();break;case"search":a.searchIntroStart()}};var v=!1,w={};a.checkIntroAutoStart=function(){if(v){var b=q();w[b]||(w[b]=!0,a.intro())}},a.beforeChangeEvent=function(a){var b=angular.element(a).prop("id");"main-menu-button"==b&&$("html, body").animate({scrollTop:0},600)},a.introComplete=function(){$("html, body").animate({scrollTop:0},600)};var x=function(){var b=i("translate");a.baseIntroOptions={nextLabel:"<b>"+b("Next")+"</b>",prevLabel:b("Previous"),skipLabel:b("Skip"),doneLabel:"<b>"+b("Got it")+"</b>",exitOnEsc:!0,exitOnOverlayClick:!v,showStepNumbers:!1,keyboardNavigation:!0,showButtons:!0,showBullets:!0,showProgress:!1,scrollToElement:!0,disableInteraction:!0},a.introOptions=angular.copy(a.baseIntroOptions),a.introOptions.steps=[{element:"#animated-header",intro:b("Welcome to bangumi.moe, click 'Next' to get started.")},{element:"#tab3",intro:b("Recently on showing bangumis by weekdays. If you are looking for a latest bangumi, just select it from here. You will be able to create filter if you are not satisfied with the results.")},{element:"#bangumi-list-current",intro:b("Full list of on showing bangumis of this season is here. If you have not decided yet, the timeline may help."),position:"left"},{element:"#torrents-list-latest",intro:b("Latest posts listed here, you could load more at bottom."),position:"top"},{element:".torrent-stats",intro:b("This is the stats of the torrent: downloaded, leechers, seeders and finished."),position:"left"},{element:"#torrent-list-buttons",intro:b("You will be able to create detailed search filter and the corresponding RSS feed here.")},{element:"#main-menu-button",intro:b("Click here to register, login, add new post, manage your team and your posts, as well as request to join a specified team."),position:"left"},{element:"#guide-show-button",intro:b("And finally, you can review this guide here."),position:"top"}]};a.switchLang=function(b,c){a.showAdditionLang=!1,a.lang=b,d.use(b).then(x),c||m("locale",b,{expires:365}),k.changeLocale(b),o.lang=b},a.showTorrentDetailsDialog=function(b,c,d){c._id,a.pushTitle("Torrent",c.title),l.showModal({controller:"TorrentDetailsCtrl",templateUrl:rin_template("torrent-details"),targetEvent:b,locals:{torrent:c},onComplete:function(){var a=buildTreeview(c.content),b=new dhtmlXTreeObject("files_tree","100%","100%",0);b.setImagePath("/images/dhxtree_skyblue/"),b.loadJSONObject(a)}})["finally"](function(){a.popTitle(),d&&d()})},a.editTorrent=function(a,b,c){l.showModal({controller:"TorrentPublishCtrl",templateUrl:rin_template("torrent-publish"),targetEvent:a,locals:{torrent:b,user:c}})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.removeTorrent=function(a,b,c){var d=!1;a.preventDefault();var e=i("translate")("Are you sure you want to delete this torrent?");return confirm(e)&&(h.post("/api/torrent/remove",{_id:b._id},{cache:!1,responseType:"json"}).success(function(a){c(a&&a.success?null:!0)}).error(function(){c(!0)}),d=!0),a.stopPropagation(),d},a.downloadTorrent=function(a){a.downloads+=1;var b="/download/torrent/"+a._id+"/"+a.title.replace(/[\:\<\>\/\\\|\*\?\"]/g,"_")+".torrent",c=f.URL||f.webkitURL||f.mozURL||f.msURL,d=document.createElement("a");c&&"download"in d?(n.start(),h.get(b,{responseType:"arraybuffer"}).success(function(b){n.complete();var e=new Blob([b],{type:"application/octet-stream"}),g=c.createObjectURL(e);d.setAttribute("href",g),d.setAttribute("download",a.title+".torrent");var h=document.createEvent("MouseEvents");h.initMouseEvent("click",!0,!0,f,1,0,0,0,0,!1,!1,!1,!1,0,null),d.dispatchEvent(h)}).error(function(){n.complete()})):window.location=b},a.fetchTorrentUserAndTeam=function(a,b){for(var c=[],d=[],e=0;e<a.length;e++)a[e].uploader_id&&c.indexOf(a[e].uploader_id)<0&&c.push(a[e].uploader_id),a[e].team_id&&d.indexOf(a[e].team_id)<0&&d.push(a[e].team_id);var f=[],g=[],i={user:{_ids:c},team:{_ids:d}},k=function(c){if(c)for(var d=0;d<c.length;d++){var e=c[d].data,f=g[d];t[f].push(e);for(var h=i[f].data,j=0;j<e.length;j++)h[e[j]._id]=e[j]}for(var d=0;d<a.length;d++)i.user.data&&(a[d].uploader=i.user.data[a[d].uploader_id]),i.team.data&&(a[d].team=i.team.data[a[d].team_id]);b&&b()};for(var l in i)if(i[l]._ids.length>0){var m=t[l].find(i[l]._ids);m&&m[1]&&m[1].length&&(g.push(l),f.push(h.post("/api/"+l+"/fetch",{_ids:m[1]},{responseType:"json"}))),i[l].data=m[0]}f.length>0?j.all(f).then(k):(k(),b&&b())};var y=function(a){var b={};return a.forEach(function(a){b[a._id]=a}),b},z=function(a,b,c,d){"function"==typeof c&&(d=c,c=!1);var e=t[a];if(e){var f=function(a){c&&(a=y(a)),d(null,a)},g=e.find(b,!0);g&&g[1]&&g[1].length?h.post("/api/"+a+"/fetch",{_ids:g[1]},{cache:!1,responseType:"json"}).success(function(a){a?(e.push(a),a=g[0].concat(a)):a=g[0],f(a)}).error(function(a){d(a)}):f(g[0])}};a.fetchUsers=function(a,b,c){z("user",a,b,c)},a.fetchTags=function(a,b,c){z("tag",a,b,c)};var A=!0,B=m("locale");if(!B){v=!0,A=!1;var C=["zh_tw","zh_cn","en"];if(navigator.language){var D=navigator.language.toLowerCase().replace(/^en(-.+)/,"en").replace("-","_");C.indexOf(D)>=0&&(B=D)}B||(B="zh_tw")}a.switchLang(B,A),g.listen();var E=!1;navigator.userAgent&&(E=/^(?!.*Chrome).*?Safari/i.test(navigator.userAgent)),l.showModal=E?l.show:function(a){var b=a.onComplete;a.onComplete=function(){$("body").addClass("modal-open"),$(".md-dialog-container").addClass("modal"),b&&b()};var c=l.show(a);return c["finally"](function(){$("body").removeClass("modal-open")})}}]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider","$translateProvider","$compileProvider","redactorOptions","$disqusProvider",function(a,b,c,d,e,f,g,h){if(e.useStaticFilesLoader({prefix:"i18n/",suffix:".json"}),d.html5Mode(!0),f.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|magnet):/),b.otherwise("/"),a.state("root",{url:"/",templateUrl:rin_template("index-unified"),controller:"UnifiedIndexCtrl"}).state("tag",{url:"/tag/:tag_id",templateUrl:rin_template("tag-search"),controller:"TagSearchCtrl"}).state("bangumi",{url:"/bangumi/list",templateUrl:rin_template("bangumi-list"),controller:"BangumiListCtrl"}).state("torrent",{url:"/torrent/:torrent_id",templateUrl:rin_template("index-blank"),controller:"TorrentShowCtrl"}).state("search",{url:"/search/:tag_id",templateUrl:rin_template("search-filter"),controller:"SearchFilterCtrl"}).state("user-reset-password",{url:"/user/reset-password/:reset_key",templateUrl:rin_template("index-blank"),controller:"UserResetCtrl"}).state("help",{url:"/help",templateUrl:rin_template("page-help"),controller:"PageHelpCtrl"}).state("tellus",{url:"/tellus",templateUrl:rin_template("page-tellus"),controller:"PageTellusCtrl"}),b.deferIntercept(),c.defaults.transformRequest=function(a){if(void 0===a)return a;var b=!1;if(angular.forEach(a,function(a){a instanceof FileList&&(b=!0)}),!b)return JSON.stringify(a);var c=new FormData;return angular.forEach(a,function(a,b){a instanceof FileList?1==a.length?c.append(b,a[0]):angular.forEach(a,function(a,d){c.append(b+"_"+d,a)}):c.append(b,a)}),c},c.defaults.headers.post["Content-Type"]=void 0,g.buttonSource=!0,g.imageEnableUpload=!1,g.imageUpload="/api/file/upload/image?for=redactor",g.imageManagerJson="/api/file/all/image",g.plugins=["fontsize","fontcolor","imagemanager","fullscreen"],h.setShortname(disqus_shortname),window.location.origin)h.setUrlPrefix(window.location.origin);else{var i=window.location.href.match(/(https?:\/\/[^\/]+)\/?/i);i&&i[0]&&h.setUrlPrefix(i[1])}}]);rin.filter("to_trusted",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]).filter("tagname",["$rootScope",function(a){return function(b){if(!b)return"";var c=a.lang;return b.locale&&b.locale[c]?b.locale[c]:b.name}}]),rin.directive("backgroundImage",function(){var a=(new Date).getMonth();return function(b,c){c.css({"background-image":"url(/images/bg/m"+a+".jpg)"})}}).directive("torrentList",function(){return{restrict:"A",scope:{torrents:"=torrentList",torrentProps:"=torrentProps"},templateUrl:rin_template("torrent-list"),link:function(a){if(a.showTorrentDetailsDialog=a.$parent.showTorrentDetailsDialog,a.downloadTorrent=a.$parent.downloadTorrent,a.torrentProps){for(var b=["user","team","loadMore","showTorrentEdit","editTorrent","removeTorrent"],c=0;c<b.length;c++)a[b[c]]=a.$parent[b[c]];var d=["currentPage","totalPages","tloading"];if(a.showTorrentEdit&&a.user){var e=a.user;d.push("team"),a.isCanEdit=function(b){var c=e._id==b.uploader_id||"admin"==e.group||"staff"==e.group;if(!c&&a.team){var d=a.team;d.admin_ids&&-1!==d.admin_ids.indexOf(e._id)?c=!0:d.editor_ids&&-1!==d.editor_ids.indexOf(e._id)&&(c=!0)}return c}}a.$parent.$watchGroup(d,function(b){for(var c=0;c<d.length;c++)a[d[c]]=b[c]})}}}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).directive("fileread",[function(){return{scope:{fileread:"="},link:function(a,b){b.bind("change",function(b){a.$apply(function(){a.fileread=b.target.files})})}}}]).directive("newScope",function(){return{scope:!0,priority:450}}),rin.controller("BangumiListCtrl",["$scope","$rootScope","$http","$filter","ngProgress",function(a,b,c,d,e){function f(c,d){b.fetchTags(c,!0,function(b,c){if(c&&(d.forEach(function(a,b){a.tag_id&&(d[b].tag=c[a.tag_id])}),a.teams))for(var f in a.teams)a.teams[f]&&a.teams[f].forEach(function(a){a.tag=c[a.tag_id]});e.complete()})}e.start(),a.weekDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a.weekDayThemes=["red","pink","purple","blue","cyan","green","deep-orange"],a.bangumis=[],a.data={},b.setTitle("Bangumi List"),c.get("/api/bangumi/timeline",{responseType:"json"}).success(function(a){if(a){window.embed_path="/scripts/timelinejs/";var c=b.lang;c=c.replace("_","-"),createStoryJS({type:"timeline",width:"100%",height:"500",lang:c,source:a,embed_id:"bangumi-timeline-embed"})}}),c.get("/api/bangumi/current",{responseType:"json"}).success(function(b){if(b){for(var d=b,e=[],g=[],h=0;h<d.length;h++)g.push(d[h].tag_id),e[d[h].showOn]?e[d[h].showOn].push(d[h]):e[d[h].showOn]=[d[h]];a.bangumis=e,c.post("/api/team/working",{tag_ids:g},{cache:!1,responseType:"json"}).success(function(b){if(b){a.teams=b,a.searchStates={};var c=[];for(var e in b)b[e]&&b[e].forEach(function(a){c.indexOf(a.tag_id)<0&&c.push(a.tag_id)});g=g.concat(c)}f(g,d)}).error(function(){f(g,d)})}}).error(function(){e.complete()})}]).controller("BangumiActionsCtrl",["$scope","$http","$filter","$mdDialog","user","ngProgress",function(a,b,c,d,e,f){function g(b,c){var d=new Date(b),e=d.getTime()+6e4*d.getTimezoneOffset(),f=parseInt(a.newbangumi.timezone);if(c){var g=-(d.getTimezoneOffset()/60);f=g-(f-g)}var h=e+36e5*f;return new Date(h)}function h(a){return a&&a.name&&a.credit&&a.startDate&&a.endDate&&a.showOn>=0?!0:!1}var i=JobActionsWrapper(a,f);a.user=e,a.data={},a.bangumi={},a.newbangumi={timezone:9,showOn:0},a.date=null,a.weekDays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],a.setDate=function(b){a.settingDate=b},a.add=function(){if(i.reset()&&h(a.newbangumi)&&a.newbangumi.icon&&a.newbangumi.cover){i.start();var c={name:a.newbangumi.name,credit:a.newbangumi.credit,startDate:a.newbangumi.startDate.getTime(),endDate:a.newbangumi.endDate.getTime(),showOn:a.newbangumi.showOn,icon:a.newbangumi.icon,cover:a.newbangumi.cover};b.post("/api/bangumi/add",c,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.data.selectedIndex=1,a.bangumi=b.bangumi):i.fail()}).error(function(){i.fail()})}},a.save=function(){if(i.reset()){var c={_id:a.bangumi._id,name:a.bangumi.name,credit:a.bangumi.credit,startDate:a.newbangumi.startDate.getTime(),endDate:a.newbangumi.endDate.getTime(),showOn:a.newbangumi.showOn,icon:a.bangumi.icon,cover:a.bangumi.cover};c._id&&h(c)&&(i.start(),b.post("/api/bangumi/update",c,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?i.succeed():i.fail()}).error(function(){i.fail()}))}},a.search=function(){i.reset()&&a.bangumi.name&&(i.start(),b.post("/api/bangumi/search",{name:a.bangumi.name},{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success&&b.found){i.succeed(),a.bangumi=b.bangumi;var d=new Date(b.bangumi.startDate),e=new Date(b.bangumi.endDate);a.newbangumi.startDate=d,a.newbangumi.endDate=e,a.newbangumi.startDateFormat=c("amDateFormat")(d,"YYYY/MM/DD HH:mm:ss"),a.newbangumi.endDateFormat=c("amDateFormat")(e,"YYYY/MM/DD HH:mm:ss"),a.newbangumi.showOn=b.bangumi.showOn}else i.fail()}).error(function(){i.fail()}))},a["delete"]=function(){i.reset()&&a.bangumi._id&&(a.working=!0,b.post("/api/bangumi/remove",{_id:a.bangumi._id},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.bangumi={}):i.fail()}).error(function(){i.fail()}))},a.close=function(){d.cancel()},a.$watch("newbangumi.date",function(b){a.settingDate&&(a.newbangumi[a.settingDate+"Format"]=c("amDateFormat")(b,"YYYY/MM/DD HH:mm:ss"),a.newbangumi[a.settingDate]=g(b),a.settingDate="")}),a.$watch("newbangumi.timezone",function(){a.newbangumi.startDate=a.newbangumi.endDate=null,a.newbangumi.startDateFormat=a.newbangumi.endDateFormat=""}),a.$watch("newbangumi.weeks",function(b){if(a.newbangumi.startDate){var d=parseInt(b);if(d&&d>0){var e=new Date(a.newbangumi.startDate);e.setDate(e.getDate()+7*d),e.setMinutes(e.getMinutes()+30);var f=g(e,!0);a.newbangumi.endDate=e,a.newbangumi.endDateFormat=c("amDateFormat")(f,"YYYY/MM/DD HH:mm:ss")}}})}]),rin.controller("UnifiedIndexCtrl",["$scope","$rootScope","$state","$http","$filter","$q","$mdDialog","ngProgress",function(a,b,c,d,e,f,g,h){h.start(),a.currentPage=0,a.tloading=!1,b.$on("torrentAdd",function(b,c){a.lattorrents.unshift(c)}),b.setTitle("Index"),a.removeTorrent=function(c,d,e){b.removeTorrent(c,d,function(b){b||a.lattorrents.splice(e,1)})},a.editTorrent=function(c,d,e){b.editTorrent(c,d,a.user,function(b,c){b||(a.lattorrents[e]=c)})},a.lattorrents=[],a.coltorrents=[];var i=d.get("/api/torrent/latest",{cache:!1}),j=d.get("/api/bangumi/recent",{cache:!1}),k=d.get("/api/torrent/collections",{cache:!1}),l=[i,j,k];f.all(l).then(function(c){function d(){var c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=[],e=[],h={},i={},j=0;f.forEach(function(a){h[a.showOn]?h[a.showOn].push(a):h[a.showOn]=[a],i[a.showOn]=!0});for(var k=0,l=0;l<c.length;l++){for(var m=0,n=l;l+4>n;n++){var o=n%c.length;i[o]&&m++}m>k&&(k=m,j=l)}for(var n=j;j+4>n;n++){var o=n%c.length;e.push(c[o]),d.push(h[o])}d.length>1&&d[0]&&d[1]&&d[0].length>0&&d[1].length>0&&(g=d[0].length,d[2]&&d[2].length>0&&(g+=d[1].length,d[3]&&d[3].length>0&&(g+=1))),a.availableDays=e,a.showList=d,b.checkIntroAutoStart()}a.totalPages=c[0].data.page_count,Array.prototype.push.apply(a.lattorrents,c[0].data.torrents),Array.prototype.push.apply(a.coltorrents,c[2].data),a.currentPage=1,a.availableDays=[],a.data={},a.data.selectedIndex=2;var e=[],f=c[1].data,g=0;f.forEach(function(a){e.push(a.tag_id)}),d();var i=[].concat(a.lattorrents).concat(a.coltorrents);b.fetchTorrentUserAndTeam(i,function(){h.complete()}),b.fetchTags(e,!0,function(a,b){b&&(f.forEach(function(a,c){f[c].tag_id&&(f[c].tag=b[f[c].tag_id])}),d())})});var m=function(){a.tloading=!0,d.get("/api/torrent/page/"+(a.currentPage+1),{cache:!1,responseType:"json"}).success(function(c){if(c&&c.torrents){var d=c.torrents;b.fetchTorrentUserAndTeam(d,function(){a.tloading=!1}),Array.prototype.push.apply(a.lattorrents,d),a.currentPage+=1}else a.tloading=!1}).error(function(){a.tloading=!1})};a.loadMore=m}]),rin.controller("PageHelpCtrl",["$scope","ngProgress",function(a,b){b.complete()}]).controller("PageTellusCtrl",["$scope","ngProgress",function(a,b){b.complete()}]),rin.controller("SearchFilterCtrl",["$scope","$rootScope","$state","$stateParams","$location","$http","$q","$timeout","$filter","$mdDialog","ngProgress",function(a,b,c,d,e,f,g,h,i,j,k){a.selectedTags=[];var l=[];a.searchByTitle=!1,a.tags={},a.tagTypeList=["lang","resolution","format","misc","bangumi","team"],a.torrents=[],a.searched=!1,a.tagsCollapse=!0,a.torrentsCount=0,a.rsslink="/rss/latest",k.start(),b.setTitle("Search torrent");var m=i("translate");a.searchIntroOptions=angular.copy(b.baseIntroOptions),a.searchIntroOptions.steps=[{element:"#search-filter-header",intro:m("Welcome to search & filter page, click 'Next' to get started.")},{element:"#filter-actions",intro:m("Here, you can get a rss link and add to your own subscription if you have signin.")},{element:"#filter-tag-list",intro:m("Then, you can add or remove tags to filter by clicking the tags, and get the results instantly.")},{element:"#filter-tag-search",intro:m("Some tags are't list here, you can search them here.")},{element:"#filter-mode-switch",intro:m("After all, you can also do custom searching by title if you are't satisfied with the tags filter."),position:"left"}],h(function(){b.searchIntroStart=a.searchIntroStart,b.checkIntroAutoStart()},500),a.switchMode=function(){a.searchByTitle=!a.searchByTitle,a.keywordsTags=null,e.path(a.searchByTitle?"/search/title":"/search/index")},a.addSubscribe=function(a){l.length<=0||b.showUserDialog(a,{type:"subscribe",selectedTagIds:l})},a.update=function(){if(l.length<=0)return void e.path("/search/index");if("string"==typeof l)e.path("/search/"+l);else{for(var b="/search/",c=0;c<l.length;c++)b+=l[c],c<l.length-1&&(b+="+");e.path(b)}q(l,function(b,c){a.searched=!0,a.torrents=!b&&c?c:[]})};var n=[];if(n.push(f.get("/api/tag/popbangumi",{responseType:"json"})),n.push(f.get("/api/tag/team",{responseType:"json"})),n.push(f.get("/api/tag/common",{responseType:"json"})),d.tag_id)if("title"===d.tag_id)a.searchByTitle=!0;else if("index"!==d.tag_id)if(-1!==d.tag_id.indexOf("+")){var o=d.tag_id.split("+");n.push(f.post("/api/tag/fetch",{_ids:o},{responseType:"json"}))}else n.push(f.post("/api/tag/fetch",{_id:d.tag_id},{responseType:"json"}));g.all(n).then(function(b){for(var c={},d=0;3>d;d++)if(b[d].data)for(var e=0;e<b[d].data.length;e++){var f=b[d].data[e];c[f.type]?c[f.type].push(f):c[f.type]=[f]}if(a.tags=c,b.length>3){if(b[3].data instanceof Array)b[3].data.forEach(function(b){b&&b._id&&a.addTag(b,!0)});else{var g=b[3].data;g&&g._id&&a.addTag(g,!0)}a.update()}k.complete()}),a.searchTag=function(b){!b||b.length<2||(k.start(),a.searching="Searching...",f.post("/api/tag/search",{name:b,multi:!0},{responseType:"json"}).success(function(b){if(k.complete(),b.success&&b.found){a.searching="Search results for: ";for(var c=0;c<b.tag.length;c++)a.addTag(b.tag[c],!0);a.update()}else a.searching="No results found for: "}).error(function(){k.complete(),a.searching="Server error when searching for: "}))},a.canceler=null,a.$watch("newTagName",function(b){a.canceler&&a.canceler.resolve();var c=b;c&&c.length>=2?(a.canceler=g.defer(),f.post("/api/tag/search",{name:c,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null}),a.searchTitle=function(b){!b||b.length<2||q(b,function(b,c){a.searched=!0,a.torrents=!b&&c?c:[]})};var p=function(a,b){if(!a)return-1;for(var c=0;c<a.length;c++)if(a[c]._id==b._id)return c;return-1};a.addTag=function(b,c){var d=p(a.tags[b.type],b);d>=0&&a.tags[b.type].splice(d,1),p(a.selectedTags,b)>=0||(a.selectedTags.push(b),l.push(b._id),c||a.update())},a.removeTag=function(b){var c=p(a.selectedTags,b);c>=0&&(a.selectedTags.splice(c,1),l.splice(l.indexOf(b._id),1)),a.tags[b.type]?a.tags[b.type].push(b):a.tags[b.type]=[b],0===a.selectedTags.length&&(a.searched=!1,a.rsslink="/rss/latest"),a.update()};var q=function(c,d,e){"function"==typeof d&&(e=d,d=1);var g={},h="/rss/tags/",i="/api/torrent/search";"string"==typeof c?(g.title=c,h="",i+="/title"):(g.tag_id=c,c.forEach(function(a,b){h+=a+(b+1<c.length?"+":"")})),a.rsslink=h,d>1?g.p=d:(a.torrentsCount=0,a.currentPage=0),f.post(i,g,{responseType:"json"}).success(function(c){c&&c.torrents?(1>=d&&(a.torrentsCount=c.count,a.totalPages=c.page_count),a.currentPage++,b.fetchTorrentUserAndTeam(c.torrents,function(){}),e(null,c.torrents)):e()}).error(function(){e()})};a.currentPage=0,a.totalPages=0,a.tloading=!1;var r=!1,s=function(){if(!(a.currentPage>0&&a.currentPage>=a.totalPages||r)){r=!0,a.tloading=!0;var b=function(b,c){Array.prototype.push.apply(a.torrents,c),r=!1,a.tloading=!1};a.searchByTitle?q(a.title,a.currentPage+1,b):q(l,a.currentPage+1,b)}};a.loadMore=s}]),rin.controller("SidebarCtrl",["$scope","$rootScope","$http","$mdDialog","md5","ngProgress","$disqus",function(a,b,c,d,e,f,g){a.isExpanded=!1,a.setUser=function(d){d&&(d.email&&(d.emailHash=e.createHash(d.email)),d._id&&c.get("/api/user/sso/disqus",{cache:!1,responseType:"json"}).success(function(a){a&&g.sso(a)}),d.receive_email!==!1&&(d.receive_email=!0)),a.user=d,b.user=d},a.expand=function(b){a.user?a.isExpanded=!a.isExpanded:a.showSigninDialog(b)},a.signout=function(){f.start(),c["delete"]("/api/user/signout",{cache:!1,responseType:"json"}).success(function(b){b&&b.success&&(a.setUser(null),a.isExpanded=!1,f.complete())})},a.showSigninDialog=function(b){d.show({controller:"UserSigninCtrl",templateUrl:rin_template("user-signin"),targetEvent:b,locals:{user:null}}).then(function(b){a.setUser(b),a.expand()})},a.showTeamDialog=function(b){d.show({controller:"TeamActionsCtrl",templateUrl:rin_template("team-actions"),targetEvent:b,locals:{user:a.user}}).then(function(){})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.showTagDialog=function(b){d.show({controller:"TagActionsCtrl",templateUrl:rin_template("tag-actions"),targetEvent:b,locals:{user:a.user}}).then(function(){})["finally"](function(){})},a.showBangumiDialog=function(b){d.show({controller:"BangumiActionsCtrl",templateUrl:rin_template("bangumi-actions"),targetEvent:b,clickOutsideToClose:!1,locals:{user:a.user}}).then(function(){})["finally"](function(){})},a.showPublishDialog=function(c){d.showModal({controller:"TorrentPublishCtrl",templateUrl:rin_template("torrent-publish"),targetEvent:c,clickOutsideToClose:!1,locals:{user:a.user,torrent:null}}).then(function(c){c&&(c.uploader=a.user,b.$emit("torrentAdd",c))})["finally"](function(){$(".redactor-toolbar-tooltip").remove()})},a.showUserDialog=function(b,c){d.show({controller:"UserActionsCtrl",templateUrl:rin_template("user-actions"),targetEvent:b,locals:{user:a.user,action:c}}).then(function(){})["finally"](function(){})},b.showUserDialog=a.showUserDialog,c.get("/api/user/session",{cache:!1,responseType:"json"}).success(function(b){b&&b._id&&a.setUser(b)})}]),rin.controller("TagActionsCtrl",["$scope","$http","$mdDialog","$q","user","ngProgress",function(a,b,c,d,e,f){function g(){if(a.tag.synonyms&&!(a.tag.synonyms.length<=0)){for(var b={},c=a.tag_locale,d=0;d<c.length;d++)if(c[d]&&a.tag.synonyms[d])if(c[d].indexOf(",")>=0)for(var e=c[d].split(","),f=0;f<e.length;f++)e[f]&&(b[e[f]]=a.tag.synonyms[d]);else b[c[d]]=a.tag.synonyms[d];return b}}function h(){if(!a.tag.synonyms||!a.tag.locale||a.tag.synonyms.length<=0)return void(a.tag_locale=[""]);var b=[];for(var c in a.tag.locale){var d=a.tag.synonyms.indexOf(a.tag.locale[c]);d>=0&&(b[d]?b[d]+=","+c:b[d]=c)}a.tag_locale=b}var i=JobActionsWrapper(a,f);a.tagTypeList=["team","bangumi","lang","resolution","format","misc"],a.user=e,a.tag={},a.tag_locale=[],a.search=function(){!a.canceler&&i.reset()&&a.tag.name&&(i.start(),b.post("/api/tag/search",{name:a.tag.name},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),b.found?(a.tag=b.tag,h()):(a.tag.synonyms=[""],a.tag_locale=[""],a.notfound=!0),a.keywordsTags=null):i.fail()}).error(function(){i.fail()}))},a.increase=function(){a.tag.synonyms.push(""),a.tag_locale.push("")},a.remove=function(b){a.tag.synonyms.splice(b,1),a.tag_locale.splice(b,1)},a.add=function(){if(i.reset()&&a.notfound){i.start();var c={name:a.tag.name,type:a.tag.type,synonyms:a.tag.synonyms,locale:g()};b.post("/api/tag/add",c,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.notfound=!1,a.tag=b.tag):i.fail()}).error(function(){i.fail()})}},a.save=function(){if(i.reset()&&a.tag._id){i.start();var c={_id:a.tag._id,name:a.tag.name,type:a.tag.type,synonyms:a.tag.synonyms,locale:g()};b.post("/api/tag/update",c,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?i.succeed():i.fail()}).error(function(){i.fail()})}},a["delete"]=function(){i.reset()&&a.tag._id&&(i.start(),b.post("/api/tag/remove",{_id:a.tag._id},{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(i.succeed(),a.notfound=!1,a.tag={},a.tag_locale=[]):i.fail()}).error(function(){i.fail()}))},a.selectTag=function(b){a.tag=b,h(),a.keywordsTags=null},a.close=function(){c.cancel()},a.canceler=null,a.$watch("tag.name",function(c){if(a.canceler&&a.canceler.resolve(),a.tag._id)return a.canceler=null,void(a.keywordsTags=null);var e=c;e&&e.length>=2?(a.canceler=d.defer(),b.post("/api/tag/search",{name:e,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("TagSearchCtrl",["$stateParams","$scope","$rootScope","$http","$location","$filter","ngProgress",function(a,b,c,d,e,f,g){g.complete(),b.removeTorrent=function(a,d,e){c.removeTorrent(a,d,function(a){a||b.torrents.splice(e,1)})},b.editTorrent=function(){},c.setTitle("Tag");var h=a.tag_id;if(!h)return void e.path("/");b.torrents=[],b.currentPage=0,b.totalPages=0,b.tloading=!1;var i=!1,j=function(){if(!(b.currentPage>0&&b.currentPage>=b.totalPages||i)){i=!0,b.tloading=!0;var a=b.currentPage+1,e={type:"tag",tag_id:h,p:a};d.post("/api/torrent/search",e,{cache:!1,responseType:"json"}).success(function(d){if(d&&d.torrents){var e=d.torrents;c.fetchTorrentUserAndTeam(e,function(){b.tloading=!1}),Array.prototype.push.apply(b.torrents,e),1==a&&(b.totalPages=d.page_count),b.currentPage+=1}else b.tloading=!1;i=!1}).error(function(){b.tloading=!1,i=!1})}};b.loadMore=j,c.fetchTags([h],function(a,d){d&&d.length>0&&(b.tag=d[0],c.setTitle("Tag",f("tagname")(b.tag)))}),b.loadMore()}]),rin.controller("TeamActionsCtrl",["$scope","$rootScope","$http","$q","$mdDialog","user","ngProgress",function(a,b,c,d,e,f,g){var h=JobActionsWrapper(a,g);a.user=f,a.data={},a.syncSites=["dmhy","ktxp","popgo","camoe"];var i=function(){a.sync={};for(var b=0;b<a.syncSites.length;b++)a.sync[a.syncSites[b]]={}};i(),a.newteam={},a.jointeam={},a.selectedTeamIndex=-1,a.selectTeam=function(b){if(a.selectedTeamIndex!=b&&(a.selectedTeamIndex=b,a.teams&&a.teams[b])){g.start(),a.teamPendingMembers=null,a.teamMembers=null,i();var e=a.teams[b];a.team=e;var h="?team_id="+e._id,j=[];j.push(c.get("/api/team/members"+h,{responseType:"json"})),j.push(c.get("/api/team/sync/get"+h,{cache:!1,responseType:"json"})),e.admin_ids&&-1!==e.admin_ids.indexOf(f._id)&&j.push(c.get("/api/team/members/pending"+h,{responseType:"json"})),d.all(j).then(function(b){if(a.teamMembers=b[0].data,b[1].data)for(var c=b[1].data,d=0;d<a.syncSites.length;d++){var e=a.syncSites[d];c[e]&&(a.sync[e]=c[e])}j.length>2&&(a.teamPendingMembers=b[2].data),g.complete()})}},a.isTeamAdmin=function(b){return a.team&&a.team.admin_ids&&-1!==a.team.admin_ids.indexOf(b)?!0:!1},a.isTeamEditor=function(b){return a.team&&a.team.editor_ids&&-1!==a.team.editor_ids.indexOf(b)?!0:!1},c.get("/api/team/myteam",{responseType:"json"}).success(function(c){if(c&&c.length>0){a.teams=c,a.data.selectedIndex=0;for(var d=[],e=0;e<c.length;e++)c[e].tag_id&&d.push(c[e].tag_id);b.fetchTags(d,!0,function(a,b){b&&c.forEach(function(a,d){a.tag_id&&(c[d].tag=b[a.tag_id])})}),1===c.length&&a.selectTeam(0)}});var j=function(){c.get("/api/team/myjoining",{responseType:"json"}).success(function(b){b&&b.length>0&&(b=b[0],a.teamJoining=b,a.jointeam.name=b.name)})};j(),c.get("/api/team/pending",{cache:!1,responseType:"json"}).success(function(b){a.teamPending=b}),"admin"==f.group&&c.get("/api/team/all/pending",{cache:!1,responseType:"json"}).success(function(c){var d=c;a.teamRequests=d;var e=[];c.forEach(function(a){a.admin_id&&e.indexOf(a.admin_id)<0&&e.push(a.admin_id)}),e.length>0&&b.fetchUsers(e,!0,function(a,b){if(b)for(var c=0;c<d.length;c++)d[c].admin=b[d[c].admin_id]})}),a.join=function(){if(!a.canceler&&h.reset()){var b=a.jointeam;b&&b.name&&(h.start(),c.post("/api/team/join",b,{cache:!1,responseType:"json"}).success(function(b){a.keywordsTags=null,b&&b.success?(j(),h.succeed()):h.fail()}).error(function(){h.fail()}))}},a.remove=function(b,d,e,f){if(h.reset()){var g={team_id:d,user_id:e};f&&(g.type=f),c.post("/api/team/remove",g,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)if("member"==f){for(var c=a.teamMembers,d=0;d<c.length;d++)if(c[d]._id==e){c.splice(d,1);break}}else if("editor"==f||"admin"==f)for(var g="editor"==f?a.team.editor_ids:a.team.admin_ids,d=0;d<g.length;d++)if(g[d]==e){g.splice(d,1);break}})}},a.approve=function(b,d,e,f){if(h.reset()){var g={team_id:d,user_id:e};f&&(g.type=f),c.post("/api/team/approve",g,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)if("admin"==f)a.team.admin_ids.push(e);else if("editor"==f)a.team.editor_ids?a.team.editor_ids.push(e):a.team.editor_ids=[e];else for(var c="member"==f,g=c?a.teamPendingMembers:a.teamRequests,h=0;h<g.length;h++){if(c&&g[h]._id==e){a.teamMembers.push(g[h]),g.splice(h,1);break}if(!c&&g[h]._id==d){g.splice(h,1);break}}})}},a.reject=function(b,d,e,f){if(h.reset()){var g={team_id:d,user_id:e};f&&(g.type=f),c.post("/api/team/reject",g,{cache:!1,responseType:"json"}).success(function(b){if(b&&b.success)for(var c="member"==f,g=c?a.teamPendingMembers:a.teamRequests,h=0;h<g.length;h++)if(c&&g[h]._id==e||!c&&g[h]._id==d){g.splice(h,1);break}})}},a.approveMember=function(b,c,d){return a.approve(b,c,d,"member")
},a.approveEditor=function(b,c,d){return a.approve(b,c,d,"editor")},a.approveAdmin=function(b,c,d){return a.approve(b,c,d,"admin")},a.rejectMember=function(b,c,d){return a.reject(b,c,d,"member")},a.removeEditor=function(b,c,d){return a.remove(b,c,d,"editor")},a.removeAdmin=function(b,c,d){return a.remove(b,c,d,"admin")},a.save=function(){if(a.team&&h.reset()){if(3==a.data.selectedIndex)return void(a.sync&&(h.start(),c.post("/api/team/sync/update",{sync:a.sync,team_id:a.team._id},{cache:!1,responseType:"json"}).success(function(a){a&&a.success?h.succeed():h.fail()}).error(function(){h.fail()})));var b=a.team;if(b){h.start();var d={_id:b._id,icon:b.new_icon};d.signature=b.signature?b.signature:"",c.post("/api/team/update",d,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?h.succeed():h.fail()}).error(function(){h.fail()})}}},a.submit=function(){if(h.reset()){var b=a.newteam;b&&b.name&&b.certification&&(h.start(),c.post("/api/team/register",b,{cache:!1,responseType:"json"}).success(function(b){b&&b.success?(h.succeed(),a.teamPending=b.team):h.fail()}).error(function(){h.fail()}))}},a.close=function(){e.cancel()},a.selectTag=function(b){a.jointeam.name=b.name},a.canceler=null,a.$watch("jointeam.name",function(b){if(a.canceler&&a.canceler.resolve(),a.teamJoining&&a.teamJoining._id)return a.canceler=null,void(a.keywordsTags=null);var e=b;e&&e.length>=2?(a.canceler=d.defer(),c.post("/api/tag/search",{name:e,type:"team",keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]),rin.controller("TorrentShowCtrl",["$state","$stateParams","$scope","$rootScope","$location","$http","$mdDialog","ngProgress",function(a,b,c,d,e,f,g,h){var i=b.torrent_id;return i?void f.post("/api/torrent/fetch",{_id:i},{responseType:"json"}).success(function(b){if(b){var c=b;d.fetchTorrentUserAndTeam([c],function(){h.complete()}),d.showTorrentDetailsDialog(null,c,function(){a.current&&"torrent"==a.current.name&&e.path("/")})}else h.complete()}).error(function(){h.complete()}):void e.path("/")}]).controller("TorrentPublishCtrl",["$scope","$rootScope","$state","$filter","$http","$timeout","$mdDialog","$mdToast","$q","user","torrent","ngProgress",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=JobActionsWrapper(a,l);a.user=j,a.tags=[],a.categoryTags=[],e.get("/api/tag/misc",{responseType:"json"}).success(function(b){if(b&&b.length){a.categoryTags=b,a.categoryTag=b[0];for(var c=0;c<b.length;c++)if(k){if(b[c]._id==k.category_tag_id){a.categoryTag=b[c];break}}else if("donga"==b[c].name.toLowerCase()){a.categoryTag=b[c];break}}}),k?(a.torrent=k,k.tag_ids&&k.tag_ids.length>0&&b.fetchTags(k.tag_ids,function(b,c){c&&(a.tags=c)})):a.torrent={},e.get("/api/team/myteam",{responseType:"json"}).success(function(c){if(c&&c.length>0){a.teams=c;for(var d=[],e=0;e<c.length;e++)c[e].tag_id&&d.push(c[e].tag_id);b.fetchTags(d,!0,function(a,b){b&&c.forEach(function(a,d){a.tag_id&&(c[d].tag=b[a.tag_id])})})}a.teams&&(k?k.team_id&&a.selectTeamByTeamId(k.team_id):a.selectTeam(0))}),a.selectTeamByTeamId=function(b){for(var c=0;c<a.teams.length;c++)if(a.teams[c]._id==b)return a.selectTeam(c),c;return-1},a.selectedTeamIndex=-1,a.selectTeam=function(b){a.selectedTeamIndex!=b&&(a.selectedTeamIndex=b,b>=0?(a.team=a.teams[b],a.torrent.inteam=!0,a.torrent.team_id=a.team._id):(a.team=null,a.torrent.inteam=!1,a.torrent.team_id=""))},a["delete"]=function(c){m.reset()&&b.removeTorrent(c,a.torrent,function(a){a?m.fail():(m.succeed(),g.hide())})&&m.start()},a.publish=function(){if(m.reset()&&a.categoryTag&&a.torrent.title&&a.torrent.introduction&&a.torrent.title.length<128){if(!a.torrent._id&&!a.torrent_file)return;m.start();var b={category_tag_id:a.categoryTag._id,title:a.torrent.title,introduction:a.torrent.introduction,tag_ids:[]};a.torrent.team_id&&(b.team_id=a.torrent.team_id);for(var c=0;c<a.tags.length;c++)b.tag_ids.push(a.tags[c]._id);var f;a.torrent._id?(f="/api/torrent/update",b._id=a.torrent._id):(f="/api/torrent/add",a.torrent.teamsync&&(b.teamsync="1"),b.file=a.torrent_file),e.post(f,b,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success)m.succeed(),g.hide(a.torrent);else{var b;a&&a.message&&(b=d("translate")(a.message)),m.fail(b)}}).error(function(){m.fail()})}},a.removeTag=function(b){a.tags.splice(b,1)},a.addTag=function(){a.newtag&&(a.working=!0,e.post("/api/tag/search",{name:a.newtag},{cache:!1,responseType:"json"}).success(function(b){if(a.working=!1,b&&b.found&&b.tag){for(var c=!1,d=0;d<a.tags.length;d++)if(a.tags[d]._id==b.tag._id){c=!0;break}c||a.tags.push(b.tag),a.newtag=""}}).error(function(){a.working=!1}))},a.contentSuggest=function(){a.torrent.title&&(a.working=!0,e.post("/api/torrent/suggest",{title:a.torrent.title,team_id:a.torrent.team_id},{cache:!1,responseType:"json"}).success(function(c){if(a.working=!1,c&&c._id){c.teamsync&&(a.torrent.teamsync=!0),c.team_id&&(a.torrent.inteam=!0),a.torrent.introduction=c.introduction;var d=c.tag_ids;if(d&&d.length>0){for(var e=[],f=0;f<d.length;f++){for(var g=!1,h=0;h<a.tags.length;h++)if(a.tags[h]._id==d[f]){g=!0;break}g||e.push(d[f])}e.length>0&&b.fetchTags(e,function(b,c){if(c&&c.length>0){for(var d=[],e=0;e<c.length;e++)if("misc"!=c[e].type)if("resolution"==c[e].type||"lang"==c[e].type){for(var f=!1,g=0;g<a.tags.length;g++)if(a.tags[g].type==c[e].type){f=!0;break}f||d.push(c[e])}else d.push(c[e]);d.length>0&&(a.tags=a.tags.concat(d))}})}}}).error(function(){a.working=!1}))},a.getSuggest=function(){a.torrent.title&&(a.working=!0,e.post("/api/tag/suggest",{query:a.torrent.title},{cache:!1,responseType:"json"}).success(function(b){if(a.working=!1,b&&b.length>0)for(var c=0;c<b.length;c++){var d,e=null,f=!1;for(e="misc"==b[c].type?a.categoryTags:a.tags,d=0;d<e.length;d++)if(e[d]._id==b[c]._id){f=!0;break}"misc"==b[c].type?f&&(a.categoryTag=e[d]):f||a.tags.push(b[c])}}).error(function(){a.working=!1}))},a.close=function(){g.cancel()};var n=null;a.$watch("torrent.title",function(){n&&f.cancel(n),n=f(a.getSuggest,2e3)}),a.addKeywordsTag=function(b){if(a.keywordsTags&&a.keywordsTags[b]){for(var c=a.keywordsTags[b],d=!1,e=0;e<a.tags.length;e++)if(a.tags[e]._id==c._id){d=!0;break}d||a.tags.push(c)}},a.canceler=null,a.$watch("newtag",function(b){a.canceler&&a.canceler.resolve();var c=b;c&&c.length>=2?(a.canceler=i.defer(),e.post("/api/tag/search",{name:c,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]).controller("TorrentDetailsCtrl",["$scope","$rootScope","$http","$timeout","$mdDialog","$window","torrent","ngProgress",function(a,b,c,d,e,f,g){a.lang=b.lang,a.torrent=g,a.user=b.user,a.showComments=!1,a.showSyncStatus=!1,d(rejustifyImagesInTorrentDetails,500),g.content&&g.content.length<=1&&(a.fileContainer=!0),g.tag_ids&&g.tag_ids.length>0&&b.fetchTags(g.tag_ids,function(b,c){c&&(a.torrent.tags=c)}),a.downloadTorrent=b.downloadTorrent;var h=a.user;if(h&&(a.canEdit=h._id==g.uploader_id||"admin"==h.group||"staff"==h.group,!a.canEdit&&g.team)){var i=g.team;i.admin_ids&&-1!==i.admin_ids.indexOf(h._id)?a.canEdit=!0:i.editor_ids&&-1!==i.editor_ids.indexOf(h._id)&&(a.canEdit=!0)}a.edit=function(c){b.editTorrent(c,a.torrent,a.user,function(){})},a.close=function(){e.cancel()}}]),rin.controller("UserResetCtrl",["$stateParams","$scope","$window","$mdDialog","ngProgress",function(a,b,c,d,e){e.complete();var f=a.reset_key;return f?void d.show({controller:"UserSigninCtrl",templateUrl:rin_template("user-signin"),clickOutsideToClose:!1,locals:{user:{resetKey:f}}}).then(function(){c.location="/"}):void(c.location="/")}]).controller("UserSigninCtrl",["$scope","$http","$filter","$mdDialog","md5","ngProgress","user",function(a,b,c,d,e,f,g){var h=JobActionsWrapper(a,f);a.user=g?g:{},g&&(a.isForgot=!0),a.switchMode=function(b){h.reset()&&("forgot"==b?(a.isRegister=!1,a.isForgot=!0):a.isForgot?(a.isRegister=!1,a.isForgot=!1):a.isRegister=!a.isRegister)},a.signin=function(){if(h.reset()&&a.user.username&&a.user.password){h.start();var f={username:a.user.username,password:e.createHash(a.user.password)};b.post("/api/user/signin",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success)h.succeed(),d.hide(a.user);else{var b;a&&a.message&&(b=c("translate")(a.message)),h.fail(b)}}).error(function(){h.fail()})}},a.register=function(){if(h.reset()){if(a.user.password!=a.user.password2||a.user.password.length<6)return a.user.password=a.user.password2="",void h.fail();if(a.user.username&&a.user.password&&a.user.email){h.start();var f={username:a.user.username,email:a.user.email,password:e.createHash(a.user.password)};b.post("/api/user/register",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success){h.succeed(),d.hide(a.user);var b=c("translate")("Got it!"),e=c("translate")("Need to verify"),f=c("translate")("Done! We've sent you an email with instructions to verify your account.");d.show(d.alert().title(e).content(f).ok(b))}else{var g;a&&a.message&&(g=c("translate")(a.message)),h.fail(g)}}).error(function(){h.fail()})}}},a.reset=function(){if(h.reset())if(!a.user.resetKey&&a.user.username&&a.user.email){h.start();var f={username:a.user.username,email:a.user.email};b.post("/api/user/reset-password/request",f,{cache:!1,responseType:"json"}).success(function(a){if(a&&a.success){h.succeed(),d.cancel();var b=c("translate")("Got it!"),e=c("translate")("Reset Password"),f=c("translate")("Done! We've sent you an email with instructions to reset your password.");d.show(d.alert().title(e).content(f).ok(b))}else h.fail()}).error(function(){h.fail()})}else if(a.user.resetKey){if(a.user.password!=a.user.password2||a.user.password.length<6)return a.user.password=a.user.password2="",void h.fail();h.start();var f={username:a.user.username,password:e.createHash(a.user.password),resetKey:a.user.resetKey};b.post("/api/user/reset-password",f,{cache:!1,responseType:"json"}).success(function(a){a&&a.success?(h.succeed(),d.hide()):h.fail()}).error(function(){h.fail()})}},a.close=function(){d.cancel()}}]).controller("UserActionsCtrl",["$scope","$rootScope","$http","$mdDialog","$q","md5","user","action","ngProgress",function(a,b,c,d,e,f,g,h,i){var j=JobActionsWrapper(a,i);a.subscriptions=[],a.focus_line=[],a.storrents=[],a.gravatarSubDomain="zh_cn"==b.lang?"cn":"zh_tw"==b.lang?"zh-tw":"en",a.showTorrentEdit=!0,a.removeTorrent=function(c,d,e){b.removeTorrent(c,d,function(b){b||(2==a.data.selectedIndex?a.mytorrents.splice(e,1):a.teamtorrents.splice(e,1))})},a.editTorrent=function(c,d,e){b.editTorrent(c,d,a.user,function(b,c){b||(1==a.data.selectedIndex?a.mytorrents[e]=c:a.teamtorrents[e]=c)})},a.user=g,a.receive_email=g.receive_email!==!1,a.data={};var k=!1;h&&"subscribe"==h.type&&h.selectedTagIds.length>0&&(k=!0,a.data.selectedIndex=1),a.selectedTeamIndex=-1,a.selectTeam=function(d){if(a.selectedTeamIndex!=d&&(a.selectedTeamIndex=d,a.team=a.teams[d],a.teamtorrents=null,a.teamtorrentsPageCount=0,a.teamCurrentPage=1,a.team)){var e=a.team._id;e&&(i.start(),c.get("/api/torrent/team?team_id="+e,{responseType:"json"}).success(function(c){if(c){var d=c.torrents;a.teamtorrents=d,a.teamtorrentsPageCount=c.page_count;var e=[];d&&d.forEach(function(a){e.indexOf(a.uploader_id)<0&&e.push(a.uploader_id)}),e.length>0?b.fetchUsers(e,!0,function(a,b){if(b)for(var c=0;c<d.length;c++)d[c].uploader=b[d[c].uploader_id];i.complete()}):i.complete()}}))}},i.start();var l=[];l.push(c.get("/api/user/subscribe/collections",{responseType:"json"})),l.push(c.get("/api/torrent/my",{responseType:"json"})),l.push(c.get("/api/team/myteam",{responseType:"json"})),e.all(l).then(function(c){var d=c[0].data;if(d&&d.length||k){var e=[];d||(d=[]);for(var f=0;f<d.length;f++)for(var g=0;g<d[f].length;g++)e.push(d[f][g]);if(k)for(var f=0;f<h.selectedTagIds.length;f++)e.push(h.selectedTagIds[f]);e.length>0&&b.fetchTags(e,!0,function(b,c){if(c){for(var e=[],f=0;f<d.length;f++){for(var g=[],i=0;i<d[f].length;i++)c[d[f][i]]&&g.push(c[d[f][i]]);g.length>0&&e.push(g)}if(k){for(var g=[],f=0;f<h.selectedTagIds.length;f++)c[h.selectedTagIds[f]]&&g.push(c[h.selectedTagIds[f]]);g.length>0&&e.push(g)}e.length>0&&(a.subscriptions=e,a.focus_line=new Array(e.length))}})}var j=c[1].data.torrents;j&&b.fetchTorrentUserAndTeam(j,function(){}),a.mytorrents=j,a.mytorrentsPageCount=c[1].data.page_count,a.teams=c[2].data,a.teams&&1==a.teams.length?a.selectTeam(0):i.complete()}),a.myCurrentPage=1,a.$watch("data.selectedIndex",function(b){2==b?(a.currentPage=a.myCurrentPage,a.totalPages=a.mytorrentsPageCount):3==b?(a.currentPage=a.teamCurrentPage,a.totalPages=a.teamtorrentsPageCount):(a.currentPage=0,a.totalPages=0)});var m=function(){var d="",e=a.data.selectedIndex,f="/api/torrent/";if(2==e)d="my?";else{if(3!=e)return;d="team?team_id="+a.team._id+"&"}a.currentPage>=a.totalPages||(i.start(),c.get(f+d+"p="+(a.currentPage+1),{cache:!1,responseType:"json"}).success(function(c){if(c&&c.torrents){var d=c.torrents;if(2==e)b.fetchTorrentUserAndTeam(d,function(){i.complete()}),Array.prototype.push.apply(a.mytorrents,d),a.myCurrentPage+=1;else if(3==e){var f=[];d&&d.forEach(function(a){f.indexOf(a.uploader_id)<0&&f.push(a.uploader_id)}),f.length>0&&b.fetchUsers(f,!0,function(a,b){for(var c=0;c<d.length;c++)d[c].uploader=b[d[c].uploader_id];i.complete()}),Array.prototype.push.apply(a.teamtorrents,d),a.teamCurrentPage+=1}a.currentPage+=1}else i.complete()}).error(function(){i.complete()}))};a.loadMore=m,a.showTorrentDetailsDialog=function(){},a.addLine=function(){a.subscriptions.push([]);for(var b=0;b<a.focus_line.length;b++)a.focus_line[b]=!1;a.ifocus=a.focus_line.length,a.focus_line.push(!0)},a.ifocus=0,a.removeLine=function(b){a.subscriptions.splice(b,1),a.ifocus==b&&(a.ifocus=-1),a.focus_line.splice(b,1)},a.editLine=function(b){a.ifocus=b,a.focus_line[b]=!0;for(var c=0;c<a.focus_line.length;c++)a.focus_line[c]=c==b},a.removeTag=function(b,c){var d=a.subscriptions[b],e=d.indexOf(c);e>=0&&d.splice(e,1),b==a.ifocus&&a.previewTorrents()},a.addKeywordsTag=function(b){if(!(a.ifocus<0)&&a.keywordsTags){var c=a.subscriptions[a.ifocus];c.indexOf(a.keywordsTags[b])>=0||(c.push(a.keywordsTags[b]),a.previewTorrents())}},a.previewTorrents=function(){if(a.storrents.splice(0,5),!(a.ifocus<0)){for(var d=a.subscriptions[a.ifocus],e=[],f=0;f<d.length;f++)e.push(d[f]._id);e.length<0||(j.start(),c.post("/api/torrent/search",{tag_id:e},{responseType:"json"}).success(function(c){c&&c.length?(c.length>5&&(c=c.slice(0,5)),b.fetchTorrentUserAndTeam(c,function(){j.succeed()}),Array.prototype.push.apply(a.storrents,c)):j.succeed()}).error(function(){j.succeed()}))}},a.save=function(){if(j.reset()){if(1==a.data.selectedIndex){for(var b=[],e=0;e<a.subscriptions.length;e++){for(var h=a.subscriptions[e],i=[],k=0;k<h.length;k++)i.push(h[k]._id);i.length>0&&b.push(i)}return j.start(),void c.post("/api/user/subscribe/update",{collections:b},{responseType:"json"}).success(function(a){a&&a.success?j.succeed():j.fail()}).error(function(){j.fail()})}var l={},m=!1;if(a.user.new_password){if(!a.user.password||a.user.new_password.length<6)return void j.fail();if(a.user.new_password!=a.user.new_password2)return a.user.new_password=a.user.new_password2="",void j.fail();l.password=f.createHash(a.user.password),l.new_password=f.createHash(a.user.new_password),m=!0}g.receive_email!=a.receive_email&&(l.receive_email=g.receive_email,a.receive_email=g.receive_email,m=!0),m&&c.post("/api/user/update",l,{responseType:"json"}).success(function(b){b&&b.success?(j.succeed(),a.user.password="",a.user.new_password=a.user.new_password2="",d.hide()):j.fail()}).error(function(){j.fail()})}},a.close=function(){d.cancel()},a.canceler=null,a.$watch("data.tagname",function(b){a.canceler&&a.canceler.resolve();var d=b;d&&d.length>=2?(a.canceler=e.defer(),c.post("/api/tag/search",{name:d,keywords:!0,multi:!0},{responseType:"json",timeout:a.canceler.promise}).success(function(b){a.keywordsTags=b&&b.found?b.tag:null,a.canceler=null}).error(function(){a.canceler=null})):a.keywordsTags=null})}]),$(document).ready(function(){$("html").removeClass("no-js");var a=-1;$(window).scroll(function(){var b=$(this).scrollTop();b>100?$(".scrollup").fadeIn():$(".scrollup").fadeOut();var c=$(".bangumi-show");if(c&&c.length){for(var d=c.find("> section.bangumi-week > md-toolbar"),e=-1,f=0;f<d.length&&b>=$(d[f]).offset().top;f++)e=f;if(0==e){var g=c.find("> md-toolbar");g&&g.length&&(g.length>0&&(g=$(g[g.length-1])),b<=g.offset().top+64&&(e=-1))}else e>0&&b<=$(d[e]).parent().offset().top-64&&e--;if(a>=0&&a!=e&&($(d[a]).attr("style","").removeClass("bangumi-top-title"),a=-1),e>=0&&a!=e){var h=$(d[0==e?e+1:e-1]).width();a=e,$(d[e]).css("width",h+"px").addClass("bangumi-top-title")}}}),$(".scrollup .fab").click(function(){return $("html, body").animate({scrollTop:0},600),!1})}),(-1!==navigator.userAgent.indexOf("MSIE")||-1!==navigator.userAgent.indexOf("Trident"))&&$("html").addClass("msie");